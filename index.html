<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SHIN-UI-SON - í†µí•© ë¶„ì„ ì‹œìŠ¤í…œ (ìµœì¢… ì™„ì„±)</title>
    <style>
        :root { --gold: #ffd700; --bg: #0b0b0b; --card: #1a1a1a; --accent: #00ffcc; --save: #ff00ff; --danger: #ff4444; }
        body { background-color: var(--bg); color: var(--gold); font-family: 'Malgun Gothic', sans-serif; padding: 8px; margin: 0; }
        .outer-border { border: 2px solid var(--gold); border-radius: 20px; padding: 12px; max-width: 480px; margin: 0 auto; }
        .header-box { text-align: center; margin-bottom: 8px; }
        
        .prev-win-label { font-size: 10px; color: #aaa; margin-bottom: 2px; }
        .next-episode { font-size: 15px; font-weight: 900; color: #fff; text-shadow: 0 0 8px rgba(255,215,0,0.5); margin-bottom: 2px; }
        .round-text { font-size: 17px; font-weight: 900; color: #ffd700; text-shadow: 0 0 12px #ffd700; margin: 0 0 2px 0; }
        
        .base-info { display: flex; flex-wrap: wrap; gap: 3px; justify-content: center; align-items: center; margin: 5px 0; }
        .base-num-box { width: 24px; height: 24px; line-height: 24px; text-align: center; font-size: 10px; font-weight: 900; border-radius: 50%; background: #000000; color: var(--gold); border: 1px solid var(--gold); display: inline-block; }
        .bonus-label { color: #888; font-size: 8px; margin: 0 2px; }
        
        .status-info { font-size: 10px; color: var(--accent); line-height: 1.3; min-height: 120px; width: 100%; background: rgba(255,255,255,0.05); border-radius: 12px; padding: 6px; box-sizing: border-box; margin-top: 5px; text-align: left; border: 1px solid #333; overflow-y: auto; }
        .highlight-gold { color: var(--gold); font-weight: bold; }
        .highlight-blue { color: #00ccff; font-weight: bold; }
        .replaced-in { color: #ff6666 !important; font-weight: bold; }
        .replaced-out { color: #66aaff !important; font-weight: bold; }
        .matched { color: #00ff00 !important; font-weight: bold; }
        
        .btn-group { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; margin: 3px 0; }
        button { border-radius: 8px; font-weight: bold; cursor: pointer; border: none; height: 40px; transition: 0.2s; font-size: 14px; }
        button:active { transform: scale(0.95); opacity: 0.8; }
        .btn-5set { background: linear-gradient(135deg, #00ffcc, #00a884); color: #000; }
        .btn-main { background: linear-gradient(135deg, #ffd700, #b8860b); color: #000; }
        .btn-sub { background: #222; color: #fff; border: 1px solid #444; }
        .btn-reset { grid-column: span 2; background: #333; color: #aaa; height: 34px; margin-top: 3px; font-size: 13px; }
        .btn-review { grid-column: span 2; background: #ff00ff; color: white; height: 38px; margin-top: 3px; }
        
        .round-selector { margin: 3px 0 0 0; text-align: center; border-top: 1px solid #333; padding-top: 5px; }
        .round-selector label { display: block; font-size: 12px; color: var(--accent); margin-bottom: 3px; font-weight: bold; }
        .base-round-input { display: flex; justify-content: center; align-items: center; gap: 5px; }
        .base-round-input input { width: 70px; height: 34px; text-align: center; background: #222; border: 2px solid var(--gold); color: #fff; border-radius: 8px; font-size: 14px; font-weight: bold; }
        .base-round-input button { background: var(--accent); color: #000; border: none; border-radius: 8px; padding: 0 10px; height: 34px; font-weight: bold; font-size: 13px; cursor: pointer; box-shadow: 0 0 6px rgba(0,255,204,0.3); }
        .round-desc { font-size: 9px; color: #888; margin-top: 2px; }
        
        .row-line { background: var(--card); border-radius: 10px; padding: 8px; margin-bottom: 6px; display: flex; align-items: center; justify-content: space-between; border: 1px solid #333; cursor: pointer; transition: 0.2s; }
        .row-line:hover { border-color: var(--accent); }
        .num-container { display: flex; gap: 4px; flex-grow: 1; justify-content: center; }
        
        .num-box { width: 28px; height: 28px; line-height: 28px; text-align: center; font-size: 11px; font-weight: 900; border-radius: 50%; background: #000000 !important; color: var(--gold) !important; border: 1px solid var(--gold) !important; }
        .num-box.eliminated { border-color: #ff8888 !important; color: #ff8888 !important; }
        .num-box.replaced-in { border-color: #ff6666 !important; color: #ff6666 !important; background: #330000 !important; }
        .num-box.replaced-out { border-color: #66aaff !important; color: #66aaff !important; background: #001a33 !important; }
        .num-box.matched { border-color: #00ff00 !important; color: #00ff00 !important; background: #003300 !important; }
        
        .combo-label { font-size: 13px; font-weight: bold; color: var(--accent); margin-right: 6px; min-width: 40px; }
        .save-btn { font-size: 10px; background: var(--save); color: white; padding: 4px 6px; border-radius: 5px; cursor: pointer; margin-left: 6px; }
        .badge { font-size: 9px; background: #333; padding: 2px 4px; border-radius: 8px; margin-left: 4px; color: #aaa; }
        
        .popup-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 1000; }
        .popup-content { background: var(--card); border: 2px solid var(--gold); border-radius: 18px; padding: 15px; max-width: 420px; width: 90%; max-height: 90vh; overflow-y: auto; position: relative; }
        .popup-close { position: absolute; top: 8px; right: 12px; font-size: 24px; background: transparent; border: none; color: var(--gold); cursor: pointer; z-index: 1100; padding: 5px 10px; }
        .popup-title { font-size: 17px; font-weight: bold; margin-bottom: 12px; text-align: center; color: var(--gold); }
        
        .user-info { background: #333; color: var(--accent); padding: 2px 6px; border-radius: 16px; font-size: 10px; margin-bottom: 5px; text-align: center; display: inline-block; }
        .change-name-btn { background: #00ccff; color: white; border: none; border-radius: 4px; padding: 2px 5px; font-size: 9px; margin-left: 4px; cursor: pointer; }
        
        .small-note { margin-top: 2px; color: #888; font-size: 8px; text-align: center; }
        *:focus, *:active { outline: none; -webkit-tap-highlight-color: transparent; }
        
        .game-tabs { display: flex; gap: 4px; margin-bottom: 10px; border-bottom: 1px solid #444; padding-bottom: 4px; }
        .game-tab { flex: 1; background: #222; color: #aaa; border: 1px solid #444; border-radius: 5px; padding: 5px 0; font-size: 12px; cursor: pointer; }
        .game-tab.active { background: var(--accent); color: #000; font-weight: bold; border-color: var(--accent); }
        .game-panel { display: none; }
        .game-panel.active { display: block; }
        .game-canvas { width: 100%; height: 220px; background: #1a1a1a; border-radius: 10px; border: 1px solid #444; margin: 5px 0; touch-action: none; }
        .selected-numbers { display: flex; gap: 5px; justify-content: center; margin: 6px 0; flex-wrap: wrap; }
        .selected-ball { width: 32px; height: 32px; border-radius: 50%; background: #000; border: 2px solid var(--gold); color: var(--gold); display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 13px; }
        .game-btn-group { display: flex; gap: 6px; justify-content: center; margin-top: 6px; }
        .game-btn { background: var(--accent); color: #000; border: none; border-radius: 6px; padding: 6px 12px; font-weight: bold; cursor: pointer; font-size: 13px; height: auto; }
        .game-btn:disabled { opacity: 0.5; background: #444; color: #aaa; cursor: not-allowed; transform: none; }
        .reaction-box { width: 100%; height: 130px; background: #222; border-radius: 10px; display: flex; align-items: center; justify-content: center; color: #fff; font-size: 15px; cursor: pointer; margin: 8px 0; }
        .reaction-result { margin-top: 6px; font-size: 13px; color: var(--gold); text-align: center; }
        
        .winning-input { display: flex; gap: 4px; justify-content: center; margin: 10px 0; flex-wrap: wrap; }
        .winning-input input { width: 36px; height: 36px; text-align: center; background: #222; border: 1px solid #444; color: #fff; border-radius: 5px; font-size: 13px; }
        .result-box { background: #222; border: 1px solid #444; border-radius: 8px; padding: 8px; margin: 8px 0; font-size: 12px; }
        .match-count { font-size: 15px; color: var(--gold); }
        .combo-item { display: flex; justify-content: space-between; padding: 4px; border-bottom: 1px solid #333; font-size: 11px; }
        .winning-display { font-size: 12px; color: #ffd700; margin-bottom: 8px; text-align: center; }
        
        .section-row { display: flex; align-items: center; margin: 4px 0; padding: 4px; background: #1a1a1a; border-radius: 5px; }
        .section-label { width: 45px; color: var(--accent); font-size: 11px; }
        .section-nums { display: flex; gap: 3px; flex-wrap: wrap; }
        
        .combo-list { max-height: 350px; overflow-y: auto; }
        .combo-item-row { display: flex; justify-content: space-between; align-items: center; padding: 5px; border-bottom: 1px solid #333; }
        .combo-item-row:last-child { border-bottom: none; }
        .combo-nums { display: flex; gap: 3px; }
        .combo-save-btn { background: var(--save); color: white; border: none; border-radius: 4px; padding: 3px 6px; font-size: 9px; cursor: pointer; }
        .combo-save-btn:active { transform: scale(0.95); opacity: 0.8; }

        .ai-info-box { background: #1a1a1a; border-radius: 6px; padding: 6px; margin: 8px 0; font-size: 11px; border: 1px solid #444; }
        .ai-info-box div { margin: 2px 0; }
        
        .control-panel { margin: 5px 0; border-top: 1px solid #333; padding-top: 5px; }
        .slider-container { display: flex; align-items: center; gap: 8px; justify-content: center; }
        .slider-container input[type=range] { flex: 3; height: 6px; background: var(--accent); border-radius: 3px; -webkit-appearance: none; }
        .slider-container input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; width: 18px; height: 18px; background: var(--gold); border-radius: 50%; cursor: pointer; }
        .batch-input { display: flex; gap: 5px; justify-content: center; align-items: center; }
        .batch-input input { width: 70px; background: #222; border: 2px solid var(--accent); color: #fff; border-radius: 8px; text-align: center; height: 34px; }
        .custom-combo-row { grid-column: span 2; display: flex; gap: 5px; margin-top: 3px; }
        .custom-combo-row input { flex: 2; background: #222; border: 2px solid var(--accent); color: #fff; border-radius: 8px; text-align: center; height: 40px; }
        .custom-combo-row button { flex: 3; background: var(--accent); color: #000; height: 40px; }
    </style>
</head>
<body>
<div class="outer-border">
    <div class="header-box">
        <div class="prev-win-label" id="prevWinLabel">ğŸ“Œ ê¸°ì¤€ ì´ì „íšŒì°¨ ë‹¹ì²¨ë²ˆí˜¸</div>
        <div class="base-info" id="baseRoundInfo"></div>
        <div class="next-episode">SHIN-UI-SON + í†µí•© ë¶„ì„ (ìµœì¢… ì™„ì„±)</div>
        <div class="round-text" id="roundDisplay">ì˜ˆìƒ íšŒì°¨</div>
        <div id="userDisplay" class="user-info"></div>
        <div id="status" class="status-info">ì—”ì§„ ì´ˆê¸°í™” ì¤‘...</div>
    </div>

    <!-- ì••ì¶•ìˆ˜ ì„ íƒ ìŠ¬ë¼ì´ë” (10~15) -->
    <div class="control-panel">
        <label>ğŸ”¢ ì••ì¶•ìˆ˜ ì„ íƒ (10~15)</label>
        <div class="slider-container">
            <input type="range" id="compressRange" min="10" max="15" value="10" step="1" 
                   oninput="document.getElementById('compressValue').innerText = this.value">
            <span id="compressValue" style="min-width:30px; color:var(--gold); font-weight:bold;">10</span>
            <button onclick="applyCompress()" style="background:var(--accent); color:#000; border:none; border-radius:8px; padding:4px 10px;">ì ìš©</button>
        </div>
        <div class="round-desc">AI ì¶”ì²œ ìˆ«ì ê°œìˆ˜ (10~15). 5/10ì¡°í•© ìƒì„± ì‹œ ë°˜ì˜ë©ë‹ˆë‹¤.</div>
    </div>

    <!-- ë¶„ì„ ì„¤ì •: ê°„ê²©(ì£¼) ë° ì°¸ì¡° íšŒì°¨ ìˆ˜ -->
    <div class="control-panel">
        <label>ğŸ“… ë¶„ì„ ì„¤ì •</label>
        <div style="display:flex; gap:5px; justify-content:center; align-items:center; flex-wrap:wrap;">
            <input type="number" id="intervalWeeks" min="1" max="200" value="51" style="width:60px; background:#222; border:2px solid var(--accent); color:#fff; border-radius:8px; text-align:center; height:34px;">
            <span style="color:var(--gold);">ì£¼ ê°„ê²©</span>
            <input type="number" id="refCount" min="1" max="10" value="4" style="width:60px; background:#222; border:2px solid var(--accent); color:#fff; border-radius:8px; text-align:center; height:34px;">
            <span style="color:var(--gold);">ê°œ íšŒì°¨</span>
            <button onclick="applyAnalysisSettings()" style="background:var(--accent); color:#000; border:none; border-radius:8px; padding:4px 10px;">ì ìš©</button>
        </div>
        <div class="round-desc">ê³¼ê±° íšŒì°¨ ê°„ê²©ê³¼ ê°œìˆ˜ë¥¼ ì„¤ì •í•©ë‹ˆë‹¤. (ê°€ì¤‘ì¹˜ ìë™ ì¡°ì •)</div>
    </div>

    <!-- ì—°ì† ë¶„ì„ / í†µí•© ë¶„ì„ ë²„íŠ¼ -->
    <div class="control-panel">
        <label>ğŸ“Š ë¶„ì„ ëª¨ë“œ</label>
        <div style="display:flex; gap:5px; justify-content:center;">
            <button class="btn-sub" onclick="runBatchAnalysis()" style="flex:1;">ğŸ“ˆ ì—°ì† ë¶„ì„ (ê°œë³„)</button>
            <button class="btn-sub" onclick="runIntegratedAnalysis()" style="flex:1; background:#ffaa00;">ğŸ”— í†µí•© ë¶„ì„</button>
        </div>
        <div class="round-desc">ì—°ì†: ê° íšŒì°¨ë³„ ê²°ê³¼ | í†µí•©: ì—¬ëŸ¬ íšŒì°¨ í•©ì³ í•˜ë‚˜ì˜ ê²°ê³¼</div>
    </div>

    <!-- ë¶„ì„ ë²”ìœ„ ì…ë ¥ (1~30) -->
    <div class="control-panel">
        <label>ğŸ”¢ ë¶„ì„ ë²”ìœ„ (1~30íšŒ)</label>
        <div class="batch-input">
            <input type="number" id="batchCount" min="1" max="30" value="10">
        </div>
        <div class="round-desc">ì—°ì†/í†µí•© ë¶„ì„ì— ì‚¬ìš©í•  íšŒì°¨ ìˆ˜</div>
    </div>

    <!-- ê¸°ì¡´ íšŒì°¨ ì„ íƒ -->
    <div class="round-selector">
        <label>ğŸ¯ ë¶„ì„í•  íšŒì°¨ ì„ íƒ</label>
        <div class="base-round-input">
            <input type="number" id="baseRoundInput" min="901" max="1300" value="1213" step="1">
            <button onclick="setBaseRound()">ì„¤ì •</button>
        </div>
        <div class="round-desc">(900~1212 ë°ì´í„° ê¸°ë°˜)</div>
    </div>

    <!-- ë²„íŠ¼ ê·¸ë£¹ -->
    <div class="btn-group">
        <button class="btn-5set" onclick="process(5)">5ì¡°í•©</button>
        <button class="btn-main" onclick="process(10)">10ì¡°í•©</button>
        <button class="btn-sub" onclick="openPopup()">ë³´ê´€í•¨</button>
        <button class="btn-sub" onclick="openGamePopup()">ğŸ® ê²Œì„ì„¼í„°</button>
        <button class="btn-sub" onclick="clearStorage()">ì´ˆê¸°í™”</button>
        <button class="btn-sub btn-reset" onclick="location.reload()">ìƒˆë¡œê³ ì¹¨</button>
        <button class="btn-review" onclick="openReviewPopup()">ğŸ“Š ë³µê¸°</button>
        <button class="btn-sub" onclick="showComboList()">ğŸ“‹ ì¡°í•© ëª©ë¡</button>
        <!-- ì‚¬ìš©ì ì§€ì • ì¡°í•© ê°œìˆ˜ ì…ë ¥ -->
        <div class="custom-combo-row">
            <input type="number" id="customComboCount" min="1" max="30" value="7" placeholder="ê°œìˆ˜">
            <button onclick="process(parseInt(document.getElementById('customComboCount').value))">ìƒì„±</button>
        </div>
    </div>

    <div id="console"></div>
    <div class="small-note">â€» 10ì¡°í•©: í™€ìˆ˜ì¡°í•©(1,3,5,7,9) 14ìˆ˜, ì§ìˆ˜ì¡°í•©(2,4,6,8,10) ì••ì¶•ìˆ˜ + ë‚¨ì€ 2ê°œ í¬í•¨ | 5ì¡°í•©: ì••ì¶•ìˆ˜ ê°€ì¤‘ì¹˜ ëœë¤ | ğŸ¯ <span id="targetRound">1213</span>íšŒì°¨ ì˜ˆìƒ</div>
</div>

<!-- í† ìŠ¤íŠ¸ ë©”ì‹œì§€ -->
<div id="toast" style="position:fixed; bottom:20px; left:0; width:100%; text-align:center; z-index:9999; display:none; pointer-events:none;">
    <span style="background:#333; color:#ffd700; padding:5px 10px; border-radius:18px; font-size:11px; box-shadow:0 2px 6px rgba(0,0,0,0.3); display:inline-block;">âœ… ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤</span>
</div>

<!-- íŒì—…ë“¤ -->
<div id="popup" class="popup-overlay" style="display:none;"><div class="popup-content"><button class="popup-close" onclick="closePopup()">&times;</button><div class="popup-title">ğŸ“¦ ë³´ê´€í•¨</div><div id="storage"></div></div></div>
<div id="gamePopup" class="popup-overlay" style="display:none;"><div class="popup-content" style="max-width:420px;"><button class="popup-close" onclick="closeGamePopup()">&times;</button><div class="popup-title">ğŸ® ê²Œì„ì„¼í„°</div><div class="game-tabs"><button class="game-tab active" data-game="touch" onclick="switchGame('touch')">í„°ì¹˜ ëŸ¬ì‰¬</button><button class="game-tab" data-game="reaction" onclick="switchGame('reaction')">ë°˜ì‘ì†ë„</button></div><div id="touchGame" class="game-panel active"><canvas id="gameCanvas" class="game-canvas"></canvas><div class="selected-numbers" id="selectedNumbersContainer"></div><div style="font-size:8px; color:#888; text-align:center;">* 6ê°œë¥¼ ì„ íƒí•˜ë©´ ì €ì¥ ë²„íŠ¼ì´ í™œì„±í™”ë©ë‹ˆë‹¤</div><div class="game-btn-group"><button class="game-btn" onclick="resetTouchGame()">ë¦¬ì…‹</button><button class="game-btn" id="saveComboBtn" onclick="saveTouchCombo()" disabled>ì¡°í•© ì €ì¥</button></div></div><div id="reactionGame" class="game-panel"><div style="text-align:center; margin:8px 0;"><div class="reaction-box" id="reactionBox" onclick="handleReactionClick()">ì‹œì‘í•˜ë ¤ë©´ ëˆ„ë¥´ì„¸ìš”</div><div class="reaction-result" id="reactionResult"></div><div class="selected-numbers" id="reactionSelectedContainer"></div><div style="font-size:8px; color:#888; text-align:center;">* 6ê°œë¥¼ ì„ íƒí•˜ë©´ ì €ì¥ ë²„íŠ¼ì´ í™œì„±í™”ë©ë‹ˆë‹¤</div><div class="game-btn-group"><button class="game-btn" onclick="resetReactionGame()">ë¦¬ì…‹</button><button class="game-btn" id="saveReactionBtn" onclick="saveReactionCombo()" disabled>ì¡°í•© ì €ì¥</button><button class="game-btn" onclick="startReaction()">ìƒˆ ê²Œì„</button></div></div></div></div></div>
<div id="reviewPopup" class="popup-overlay" style="display:none;"><div class="popup-content"><button class="popup-close" onclick="closeReviewPopup()">&times;</button><div class="popup-title" id="reviewTitle">ğŸ“Š 1213íšŒ ë³µê¸°</div><div class="winning-display" id="winningDisplay"></div><div class="ai-info-box" id="reviewAIInfo"></div><div style="text-align:center; margin-bottom:8px;" id="reviewDesc">ë‹¹ì²¨ë²ˆí˜¸ 6ê°œ + ë³´ë„ˆìŠ¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”</div><div class="winning-input"><input type="number" id="win1" min="1" max="45" step="1" placeholder="1"><input type="number" id="win2" min="1" max="45" step="1" placeholder="2"><input type="number" id="win3" min="1" max="45" step="1" placeholder="3"><input type="number" id="win4" min="1" max="45" step="1" placeholder="4"><input type="number" id="win5" min="1" max="45" step="1" placeholder="5"><input type="number" id="win6" min="1" max="45" step="1" placeholder="6"></div><div style="text-align:center; margin:5px 0;">ë³´ë„ˆìŠ¤ ë²ˆí˜¸</div><div class="winning-input"><input type="number" id="bonus" min="1" max="45" step="1" placeholder="ë³´ë„ˆìŠ¤"></div><div style="text-align:center; margin:8px 0;"><button class="game-btn" onclick="compareNumbers()">ë¹„êµí•˜ê¸°</button></div><div id="reviewResult" class="result-box"><div>AI ì¶”ì²œ ìˆ˜ì™€ ë¹„êµ:</div><div id="aiMatch" class="match-count">-</div><div id="aiMatchedList" style="font-size:12px; color:#ffd700;"></div><div id="aiBonus" style="font-size:12px; color:#aaa;"></div><div style="margin-top:6px;">ë³´ê´€í•¨ ì¡°í•© ë¹„êµ:</div><div id="savedMatch" style="max-height:140px; overflow-y:auto;"></div></div></div></div>
<div id="comboDetailPopup" class="popup-overlay" style="display:none;"><div class="popup-content"><button class="popup-close" onclick="closeComboDetailPopup()">&times;</button><div class="popup-title" id="comboDetailTitle">ì¡°í•© ìƒì„¸</div><div id="comboDetailContent"></div></div></div>
<div id="comboListPopup" class="popup-overlay" style="display:none;"><div class="popup-content"><button class="popup-close" onclick="closeComboListPopup()">&times;</button><div class="popup-title">ğŸ“‹ ìƒì„±ëœ ì¡°í•©</div><div style="text-align:right; margin-bottom:8px;"><button class="combo-save-btn" onclick="saveAllCombos()" style="background:#00ccff; color:#000; font-size:10px; padding:4px 8px;">ğŸ“¥ ëª¨ë‘ ì €ì¥</button></div><div id="comboListContent" class="combo-list"></div></div></div>

<script>
    // ===== 900~1212íšŒì°¨ ì „ì²´ ë°ì´í„° =====
    const FULL_DATA = [ [1212,5,8,25,31,41,44,45], [1211,23,26,27,35,38,40,10], [1210,1,7,9,17,27,38,31], [1209,2,17,20,35,37,39,24], [1208,6,27,30,36,38,42,25], [1207,10,22,24,27,38,45,11], [1206,1,3,17,26,27,42,23], [1205,1,4,16,23,31,41,2], [1204,8,16,28,30,31,44,27], [1203,3,6,18,29,35,39,24], [1202,5,12,21,33,37,40,7], [1201,7,9,24,27,35,36,37], [1200,1,2,4,16,20,32,45], [1199,16,24,25,30,31,32,7], [1198,26,30,33,38,39,41,21], [1197,1,5,7,26,28,43,30], [1196,8,12,15,29,40,45,14], [1195,3,15,27,33,34,36,37], [1194,3,13,15,24,33,37,2], [1193,6,9,16,19,24,28,17], [1192,10,16,23,36,39,40,11], [1191,1,4,11,12,20,41,2], [1190,7,9,19,23,26,45,33], [1189,9,19,29,35,37,38,31], [1188,3,4,12,19,22,27,9], [1187,5,13,26,29,37,40,42], [1186,2,8,13,16,23,28,35], [1185,6,17,22,28,29,32,38], [1184,14,16,23,25,31,37,42], [1183,4,15,17,23,27,36,31], [1182,1,13,21,25,28,31,22], [1181,8,10,14,20,33,41,28], [1180,6,12,18,37,40,41,3], [1179,3,16,18,24,40,44,21], [1178,5,6,11,27,43,44,17], [1177,3,7,15,16,19,43,21], [1176,7,9,11,21,30,35,29], [1175,3,4,6,8,32,42,31], [1174,8,11,14,17,36,39,22], [1173,1,5,18,20,30,35,3], [1172,7,9,24,40,42,44,45], [1171,3,6,7,11,12,17,19], [1170,3,13,28,34,38,42,25], [1169,5,12,24,26,39,42,20], [1168,9,21,24,30,33,37,29], [1167,8,23,31,35,39,40,24], [1166,14,23,25,27,29,42,16], [1165,6,7,27,29,38,45,17], [1164,17,18,23,25,38,39,22], [1163,2,13,15,16,33,43,4], [1162,20,21,22,25,28,29,6], [1161,2,12,20,24,34,42,37], [1160,7,13,18,36,39,45,19], [1159,3,9,27,28,38,39,7], [1158,21,25,27,32,37,38,20], [1157,5,7,12,20,25,26,28], [1156,30,31,34,39,41,45,7], [1155,10,16,19,27,37,38,13], [1154,4,8,22,26,32,38,27], [1153,1,9,10,13,35,44,5], [1152,30,31,32,35,36,37,5], [1151,2,3,9,15,27,29,8], [1150,8,9,18,35,39,45,25], [1149,8,15,19,21,32,36,38], [1148,3,6,13,15,16,22,32], [1147,7,11,24,26,27,37,32], [1146,6,11,17,19,40,43,28], [1145,2,11,31,33,37,44,32], [1144,3,4,12,15,26,34,6], [1143,10,16,17,27,28,36,6], [1142,2,8,28,30,37,41,22], [1141,7,11,12,21,26,35,20], [1140,7,10,22,29,31,38,15], [1139,5,12,15,30,37,40,18], [1138,14,16,19,20,29,34,35], [1137,4,9,12,15,33,45,26], [1136,21,33,35,38,42,44,1], [1135,1,6,13,19,21,33,4], [1134,3,7,9,13,19,24,23], [1133,13,14,20,28,29,34,23], [1132,6,7,19,28,34,41,5], [1131,1,2,6,14,27,38,33], [1130,15,19,21,25,27,28,40], [1129,5,10,11,17,28,34,22], [1128,1,5,8,16,28,33,45], [1127,10,15,24,30,31,37,32], [1126,4,5,9,11,37,40,7], [1125,6,14,25,33,40,44,30], [1124,3,8,17,30,33,34,28], [1123,13,19,21,24,34,35,26], [1122,3,6,21,30,34,35,22], [1121,6,24,31,32,38,44,8], [1120,2,19,26,31,38,41,34], [1119,1,9,12,13,20,45,3], [1118,11,13,14,15,16,45,3], [1117,3,4,9,30,33,36,7], [1116,15,16,17,25,30,31,32], [1115,7,12,23,32,34,36,8], [1114,10,16,19,32,33,38,3], [1113,11,13,20,21,32,44,8], [1112,16,20,26,36,42,44,24], [1111,3,13,30,33,43,45,4], [1110,3,7,11,20,22,41,24], [1109,10,12,13,19,33,40,2], [1108,7,19,26,37,39,44,27], [1107,6,14,30,31,40,41,29], [1106,1,3,4,29,42,45,36], [1105,6,16,34,37,39,40,11], [1104,1,7,21,30,35,38,2], [1103,10,12,29,31,40,44,2], [1102,13,14,22,26,37,38,20], [1101,6,7,13,28,36,42,41], [1100,17,26,29,30,31,43,12], [1099,3,20,28,38,40,43,4], [1098,12,16,21,24,41,43,15], [1097,14,33,34,35,37,40,4], [1096,1,12,16,19,23,43,34], [1095,8,14,28,29,34,40,12], [1094,6,7,15,22,26,40,41], [1093,10,17,22,30,35,43,44], [1092,7,18,19,26,33,45,37], [1091,6,20,23,24,28,30,44], [1090,12,19,21,29,40,45,1], [1089,4,18,31,37,42,43,40], [1088,11,21,22,30,39,44,31], [1087,13,14,18,21,34,44,16], [1086,11,16,25,27,35,36,37], [1085,4,7,17,18,38,44,36], [1084,8,12,13,29,33,42,5], [1083,3,7,14,15,22,38,17], [1082,21,26,27,32,34,42,31], [1081,1,9,16,23,24,38,17], [1080,13,16,23,31,36,44,38], [1079,4,8,18,24,37,45,6], [1078,6,10,11,14,36,38,43], [1077,4,8,17,30,40,43,34], [1076,3,7,9,33,36,37,10], [1075,1,23,24,35,44,45,10], [1074,1,6,20,27,28,41,15], [1073,6,18,28,30,32,38,15], [1072,16,18,20,23,32,43,27], [1071,1,2,11,21,30,35,39], [1070,3,6,14,22,30,41,36], [1069,1,10,18,22,28,31,44], [1068,4,7,19,26,33,35,3], [1067,7,10,19,23,28,33,18], [1066,6,11,16,19,21,32,45], [1065,3,18,19,23,32,45,24], [1064,3,6,9,18,22,35,14], [1063,3,6,22,23,24,38,30], [1062,20,31,32,40,41,45,12], [1061,4,24,27,35,37,45,15], [1060,3,10,24,33,38,45,36], [1059,7,10,22,25,34,40,27], [1058,11,23,25,30,32,40,42], [1057,8,13,19,27,40,45,12], [1056,13,20,24,32,36,45,29], [1055,4,7,12,14,22,33,31], [1054,14,19,27,28,30,45,33], [1053,22,26,29,30,34,45,15], [1052,5,17,26,27,35,38,1], [1051,21,26,30,32,33,35,44], [1050,6,12,31,35,38,43,17], [1049,3,5,13,20,21,37,17], [1048,6,12,17,21,32,39,30], [1047,2,20,33,40,42,44,32], [1046,7,16,25,29,35,36,28], [1045,6,14,15,19,21,41,37], [1044,12,17,20,26,28,36,4], [1043,3,5,12,22,26,31,19], [1042,5,14,15,23,34,43,4], [1041,6,7,9,11,17,18,45], [1040,8,16,26,29,31,36,11], [1039,2,3,6,19,36,39,26], [1038,7,16,24,27,37,44,2], [1037,2,14,15,22,27,33,31], [1036,2,5,22,32,34,45,39], [1035,9,14,34,35,41,42,2], [1034,26,31,32,33,38,40,11], [1033,3,11,15,20,35,44,10], [1032,1,6,12,19,36,42,28], [1031,6,7,22,32,35,36,19], [1030,2,5,11,17,24,29,9], [1029,12,30,32,37,39,41,24], [1028,5,7,12,13,18,35,23], [1027,14,16,27,35,39,45,5], [1026,5,12,13,31,32,41,34], [1025,8,9,20,25,29,33,7], [1024,9,18,20,22,38,44,10], [1023,10,14,16,18,29,35,25], [1022,5,6,11,29,42,45,28], [1021,12,15,17,24,29,45,16], [1020,12,27,29,38,41,45,6], [1019,1,4,13,17,34,39,6], [1018,3,19,21,25,37,45,35], [1017,12,18,22,23,30,34,32], [1016,15,26,28,34,41,42,44], [1015,14,23,31,33,37,40,44], [1014,3,11,14,18,26,27,21], [1013,21,22,26,34,36,41,32], [1012,5,11,18,20,35,45,3], [1011,1,9,12,26,35,38,42], [1010,9,12,15,25,34,36,3], [1009,15,23,29,34,40,44,20], [1008,9,11,30,31,41,44,33], [1007,8,11,16,19,21,25,40], [1006,8,11,15,16,17,37,36], [1005,8,13,18,24,27,29,17], [1004,7,15,30,37,39,44,18], [1003,1,4,29,39,43,45,31], [1002,17,25,33,35,38,45,15], [1001,6,10,12,14,20,42,15], [1000,2,8,19,22,32,42,39], [999,1,3,9,14,18,28,34], [998,13,17,18,20,42,45,41], [997,4,7,14,16,24,44,20], [996,6,11,15,24,32,39,28], [995,1,4,13,29,38,39,7], [994,1,3,8,24,27,35,28], [993,6,14,16,18,24,42,44], [992,12,20,26,33,44,45,24], [991,13,18,25,31,33,44,38], [990,2,4,25,26,36,37,28], [989,17,18,21,27,29,33,26], [988,2,13,20,30,31,41,27], [987,2,4,15,23,29,38,7], [986,7,10,16,28,41,42,40], [985,17,21,23,30,34,44,19], [984,3,10,23,35,36,37,18], [983,13,23,26,31,35,43,15], [982,5,7,13,20,21,44,33], [981,27,36,37,41,43,45,32], [980,3,13,16,23,24,35,14], [979,7,11,16,21,27,33,24], [978,1,7,15,32,34,42,8], [977,2,9,10,14,22,44,16], [976,4,12,14,25,35,37,2], [975,7,8,9,17,22,24,5], [974,1,2,11,16,39,44,32], [973,22,26,31,37,41,42,24], [972,3,6,17,23,37,39,26], [971,2,6,17,18,21,26,7], [970,9,11,16,21,28,36,5], [969,3,9,10,29,40,45,7], [968,2,5,12,14,24,39,33], [967,1,6,13,37,38,40,9], [966,1,21,25,29,34,37,36], [965,2,13,25,28,29,36,34], [964,6,21,36,38,39,43,30], [963,6,12,19,23,34,42,35], [962,1,18,28,31,34,43,40], [961,11,20,29,31,33,42,43], [960,2,18,24,30,32,45,14], [959,1,14,15,24,40,41,35], [958,2,9,10,16,35,37,1], [957,4,15,24,35,36,40,1], [956,10,11,20,21,25,41,40], [955,4,9,23,26,29,33,8], [954,1,9,26,28,30,41,32], [953,7,9,22,27,37,42,34], [952,4,12,22,24,33,41,38], [951,2,12,30,31,39,43,38], [950,3,4,15,22,28,40,10], [949,14,21,35,36,40,44,30], [948,13,18,30,31,38,41,5], [947,3,8,17,20,27,35,26], [946,9,18,19,30,34,40,20], [945,9,10,15,30,33,37,26], [944,2,13,16,19,32,33,42], [943,1,8,13,36,44,45,39], [942,10,12,18,35,42,43,39], [941,12,14,25,27,39,40,35], [940,3,15,20,22,24,41,11], [939,4,11,28,39,42,45,6], [938,4,8,10,16,31,36,9], [937,2,10,13,22,29,40,26], [936,7,11,13,17,18,29,43], [935,4,10,20,32,38,44,18], [934,1,3,30,33,36,39,12], [933,23,27,29,31,36,45,37], [932,1,6,15,36,37,38,5], [931,14,15,23,25,35,43,32], [930,8,21,25,38,39,44,28], [929,7,9,12,15,19,23,4], [928,3,4,10,20,28,44,30], [927,4,15,22,38,41,43,26], [926,10,16,18,20,25,31,6], [925,13,24,32,34,39,42,4], [924,3,11,34,42,43,44,13], [923,3,17,18,23,36,41,26], [922,2,6,13,17,27,43,36], [921,5,7,12,22,28,41,1], [920,2,3,26,33,34,43,29], [919,9,14,17,18,42,44,35], [918,7,11,12,31,33,38,5], [917,1,3,23,24,27,43,34], [916,6,21,22,32,35,36,17], [915,2,6,11,13,22,37,14], [914,16,19,24,33,42,44,27], [913,6,14,16,21,27,37,40], [912,5,8,18,21,22,38,10], [911,4,5,12,14,32,42,35], [910,1,11,17,27,35,39,31], [909,7,24,29,30,34,35,33], [908,3,16,21,22,23,44,30], [907,21,27,29,38,40,44,37], [906,2,5,14,28,31,32,20], [905,3,4,16,27,38,40,20], [904,2,6,8,26,43,45,11], [903,2,15,16,21,22,28,45], [902,7,19,23,24,36,39,30], [901,5,18,20,23,30,34,21], [900,7,13,16,18,35,38,14] ];

    // ===== ì „ì—­ ë³€ìˆ˜ =====
    let basket = [];
    let survivors = [];
    let zeroFreqNums = [], machineFixed = [];
    let dynamicAvgSum = 145;
    let userName = "";
    let savedNumbers = [];
    let currentBaseRound = 1213;
    let generatedCombos = [];
    let weightedScore = {};
    let bonusNums = [];
    let compressedOut4 = [];
    let full14 = [];
    let currentCompress = 10;
    let intervalWeeks = 51;
    let referenceCount = 4;

    // êµì²´ ê´€ë ¨ ì „ì—­ ë³€ìˆ˜
    let replacedIn = [];
    let replacedOut = [];
    let middle = [];

    // í†µí•© ê²°ê³¼ ì ìš© ìƒíƒœ í”Œë˜ê·¸
    let isIntegratedState = false;

    // ê²Œì„ ë³€ìˆ˜
    let touchGame = null;
    let touchInterval = null;
    let touchSelected = [];
    let reactionSelected = [];
    let reactionState = 'idle';
    let reactionTimer = null;
    let reactionStartTime = 0;

    // ===== ì‚¬ìš©ì ê´€ë¦¬ í•¨ìˆ˜ =====
    function updateUserDisplay() {
        const userDisplay = document.getElementById('userDisplay');
        userDisplay.innerHTML = `ğŸ‘¤ ${userName} 
            <button class="change-name-btn" onclick="changeName()">ì´ë¦„ë³€ê²½</button>
            <button class="change-name-btn" style="background:#ff4444;" onclick="deleteUser()">ì‚­ì œ</button>`;
    }
    function changeName() {
        const newName = prompt("ìƒˆë¡œìš´ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”:", userName);
        if (newName && newName.trim() !== "") {
            userName = newName.trim();
            localStorage.setItem('lottoUserName', userName);
            const storageKey = `lottoSave_${userName}`;
            savedNumbers = JSON.parse(localStorage.getItem(storageKey)) || [];
            updateUserDisplay();
            showToast(`ì´ë¦„ì´ ${userName}(ìœ¼)ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤`);
        }
    }
    function deleteUser() {
        if(confirm(`ì •ë§ ${userName}ë‹˜ì˜ ëª¨ë“  ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
            localStorage.removeItem(`lottoSave_${userName}`);
            userName = "guest_" + Math.random().toString(36).substring(2, 6);
            localStorage.setItem('lottoUserName', userName);
            savedNumbers = [];
            updateUserDisplay();
            showToast(`ìƒˆë¡œìš´ ì†ë‹˜ ê³„ì •(${userName})ìœ¼ë¡œ ì‹œì‘í•©ë‹ˆë‹¤`);
        }
    }
    function initUser() {
        const savedName = localStorage.getItem('lottoUserName');
        if (savedName) userName = savedName;
        else {
            userName = "guest_" + Math.random().toString(36).substring(2, 6);
            localStorage.setItem('lottoUserName', userName);
        }
        const storageKey = `lottoSave_${userName}`;
        savedNumbers = JSON.parse(localStorage.getItem(storageKey)) || [];
        updateUserDisplay();
    }
    function showToast(message, duration = 1500) {
        const toast = document.getElementById('toast');
        const span = toast.querySelector('span');
        span.innerText = message;
        toast.style.display = 'block';
        setTimeout(() => {
            toast.style.display = 'none';
        }, duration);
    }
    function saveToBox(s) {
        if (!savedNumbers.includes(s)) {
            savedNumbers.push(s);
            localStorage.setItem(`lottoSave_${userName}`, JSON.stringify(savedNumbers));
            showToast('âœ… ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤');
        } else {
            showToast('âš ï¸ ì´ë¯¸ ì €ì¥ëœ ì¡°í•©ì…ë‹ˆë‹¤');
        }
    }
    function saveAllCombos() {
        if (generatedCombos.length === 0) {
            showToast('ì €ì¥í•  ì¡°í•©ì´ ì—†ìŠµë‹ˆë‹¤');
            return;
        }
        let savedCount = 0;
        generatedCombos.forEach(combo => {
            if (!savedNumbers.includes(combo.key)) {
                savedNumbers.push(combo.key);
                savedCount++;
            }
        });
        if (savedCount > 0) {
            localStorage.setItem(`lottoSave_${userName}`, JSON.stringify(savedNumbers));
            showToast(`ğŸ“¦ ${savedCount}ê°œ ì¡°í•© ì €ì¥ë¨`);
        } else {
            showToast('ëª¨ë‘ ì´ë¯¸ ì €ì¥ëœ ì¡°í•©ì…ë‹ˆë‹¤');
        }
    }
    function deleteSingleItem(index) {
        if(confirm("ì´ ì¡°í•©ì„ ì‚­ì œí• ê¹Œìš”?")) {
            savedNumbers.splice(index, 1);
            localStorage.setItem(`lottoSave_${userName}`, JSON.stringify(savedNumbers));
            renderStorage();
            showToast('ğŸ—‘ï¸ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
        }
    }
    function loadFromStorage(nums) {
        alert(`ì„ íƒëœ ë²ˆí˜¸: ${nums.split(',').join(', ')}`);
        closePopup();
    }
    function renderStorage() {
        const st = document.getElementById('storage');
        if(savedNumbers.length === 0) { 
            st.innerHTML = "<div style='text-align:center; padding:12px; opacity:0.5;'>ì €ì¥ëœ ì¡°í•©ì´ ì—†ìŠµë‹ˆë‹¤.</div>"; 
            return; 
        }
        st.innerHTML = savedNumbers.map((n, index) => {
            const numbers = n.split(',');
            return `
                <div class="row-line" style="margin-bottom:6px; background:#2a2a2a; padding:6px;">
                    <div class="num-container">
                        ${numbers.map(v=>`<span class="num-box" style="width:24px; height:24px; line-height:24px; font-size:10px;">${v}</span>`).join('')}
                    </div>
                    <div style="display:flex; gap:4px;">
                        <button onclick="loadFromStorage('${n}')" 
                                style="background:#00ccff; color:white; border:none; border-radius:4px; padding:3px 5px; font-size:9px; cursor:pointer;">ë¶ˆëŸ¬ì˜¤ê¸°</button>
                        <button onclick="deleteSingleItem(${index})" 
                                style="background:#ff4444; color:white; border:none; border-radius:4px; padding:3px 5px; font-size:9px; cursor:pointer;">ì‚­ì œ</button>
                    </div>
                </div>
            `;
        }).join('');
        document.querySelector('.popup-title').innerHTML = `ğŸ“¦ ${userName}ì˜ ë³´ê´€í•¨ (${savedNumbers.length}ê°œ)`;
    }

    // ===== ì••ì¶•ìˆ˜ ì ìš© í•¨ìˆ˜ =====
    function applyCompress() {
        const range = document.getElementById('compressRange');
        const val = parseInt(range.value);
        if (val >= 10 && val <= 15) {
            currentCompress = val;
            analyze();
            showToast(`ì••ì¶•ìˆ˜ ${currentCompress} ì ìš©ë¨`);
        }
    }

    // ===== ë¶„ì„ ì„¤ì • ì ìš© =====
    function applyAnalysisSettings() {
        const interval = parseInt(document.getElementById('intervalWeeks').value);
        const count = parseInt(document.getElementById('refCount').value);
        if (interval > 0 && count > 0 && count <= 10) {
            intervalWeeks = interval;
            referenceCount = count;
            analyze();
            showToast(`ê°„ê²© ${interval}ì£¼, ${count}ê°œ íšŒì°¨ ì ìš©ë¨`);
        } else {
            alert('ì˜¬ë°”ë¥¸ ê°’ì„ ì…ë ¥í•˜ì„¸ìš”.');
        }
    }

    // ===== ì½”ì–´ ê³„ì‚° í•¨ìˆ˜ (ë™ì  ê°„ê²©/ê°œìˆ˜ ì ìš©) =====
    function computeForRound(round, compress) {
        const targetRounds = [];
        for (let i = 1; i <= referenceCount; i++) {
            targetRounds.push(round - intervalWeeks * i);
        }

        let mainPool = [], bonusPool = [], mainWithRound = [];
        const baseWeight = 1.6;
        const step = -0.1;
        const weights = [];
        for (let i = 0; i < referenceCount; i++) {
            weights.push(baseWeight + step * i);
        }

        targetRounds.forEach((r, idx) => {
            const row = FULL_DATA.find(x => x[0] === r);
            if (row) {
                const mainNums = row.slice(1, 7);
                mainNums.forEach(n => {
                    mainPool.push(n);
                    mainWithRound.push({ num: n, round: r, weight: weights[idx] });
                });
                bonusPool.push(row[7]);
            }
        });

        // ë¯¸ì¶œìˆ˜ ê³„ì‚° (ìµœê·¼ 22íšŒì°¨)
        let freq22 = {};
        for(let i=1; i<=45; i++) freq22[i] = 0;
        FULL_DATA.slice(0,22).forEach(row => {
            for(let j=1; j<=7; j++) if(row[j]) freq22[row[j]]++;
        });
        let zeroFreq = Object.keys(freq22).filter(n => freq22[n]===0).map(Number);

        // ê°€ì¤‘ì¹˜ ì ìˆ˜ ê³„ì‚°
        let wScore = {};
        mainWithRound.forEach(item => {
            wScore[item.num] = (wScore[item.num] || 0) + item.weight;
        });
        zeroFreq.forEach(num => {
            if (wScore[num] !== undefined) wScore[num] += 0.2;
        });

        // ì ìˆ˜ìˆœ ì •ë ¬
        let rankedMain = Object.keys(wScore).map(Number).sort((a, b) => {
            let aScore = wScore[a] || 0;
            let bScore = wScore[b] || 0;
            if (aScore > bScore) return -1;
            if (aScore < bScore) return 1;
            return a - b;
        });

        // ê³ ì • 14ìˆ˜ (ìƒìœ„8 + í•˜ìœ„6)
        let top8 = rankedMain.slice(0, 8);
        let bottom6 = rankedMain.slice(-6);
        let full14Set = new Set([...top8, ...bottom6]);
        let full14 = Array.from(full14Set).sort((a,b)=>a-b);

        // ì••ì¶•ìˆ˜ì— ë”°ë¥¸ basket ê³„ì‚°
        let topCount = Math.floor(compress * 0.6);
        let bottomCount = compress - topCount;
        topCount = Math.min(topCount, rankedMain.length);
        bottomCount = Math.min(bottomCount, rankedMain.length - topCount);
        let topPart = rankedMain.slice(0, topCount);
        let bottomPart = rankedMain.slice(-bottomCount);
        let basketSet = new Set([...topPart, ...bottomPart]);
        let basket = Array.from(basketSet).sort((a,b)=>a-b);

        // ìƒì¡´ì
        let survivorsSet = new Set([...mainPool, ...bonusPool]);
        let survivors = Array.from(survivorsSet).sort((a,b)=>a-b);

        // ë¹ ì§„ 4ê°œ
        let compressedOut = full14.filter(num => !basketSet.has(num));

        return {
            round,
            basket,
            survivors,
            compressedOut,
            full14,
            weightedScore: wScore,
            bonusNums: Array.from(new Set(bonusPool)).sort((a,b)=>a-b),
            rankedMain
        };
    }

    // ===== ë¶„ì„ í•¨ìˆ˜ (UI ì—…ë°ì´íŠ¸ + êµì²´ ë¡œì§) =====
    function analyze() {
        isIntegratedState = false; // í‘œì¤€ ë¶„ì„ ì‹œ í†µí•© ìƒíƒœ í•´ì œ

        const targetRound = currentBaseRound;
        const prevRound = targetRound - 1;
        const prevData = FULL_DATA.find(row => row[0] === prevRound);
        if (!prevData) {
            alert(`ê²½ê³ : ${prevRound}íšŒì°¨ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.`);
            return;
        }
        const lastWinning = prevData.slice(1, 7);

        const res = computeForRound(targetRound, currentCompress);
        survivors = res.survivors;
        basket = res.basket;
        full14 = res.full14;
        let originalCompressedOut = res.compressedOut;
        weightedScore = res.weightedScore;
        bonusNums = res.bonusNums;
        const rankedMain = res.rankedMain;

        // êµì²´ ë¡œì§
        let candidates = originalCompressedOut.filter(num => lastWinning.includes(num));
        if (candidates.length < 2) {
            let sortedOut = [...originalCompressedOut].sort((a, b) => (weightedScore[b] || 0) - (weightedScore[a] || 0));
            for (let num of sortedOut) {
                if (!candidates.includes(num) && candidates.length < 2) {
                    candidates.push(num);
                }
            }
        }
        candidates = [...new Set(candidates)].slice(0, 2);

        let lowestTwo = [];
        if (candidates.length > 0) {
            let basketWithScore = basket.map(num => ({ num, score: weightedScore[num] || 0 }));
            basketWithScore.sort((a, b) => a.score - b.score);
            lowestTwo = basketWithScore.slice(0, candidates.length).map(item => item.num);

            let newBasket = [...basket];
            for (let i = 0; i < candidates.length; i++) {
                let idx = newBasket.indexOf(lowestTwo[i]);
                if (idx !== -1) {
                    newBasket[idx] = candidates[i];
                }
            }
            newBasket = [...new Set(newBasket)].sort((a, b) => a - b);
            if (newBasket.length === basket.length) {
                basket = newBasket;
                compressedOut4 = originalCompressedOut.filter(num => !candidates.includes(num));
                replacedIn = candidates;
                replacedOut = lowestTwo;
            } else {
                compressedOut4 = originalCompressedOut;
                replacedIn = [];
                replacedOut = [];
            }
        } else {
            compressedOut4 = originalCompressedOut;
            replacedIn = [];
            replacedOut = [];
        }

        // middle (B bag) ê³„ì‚°
        let basketSet = new Set(basket);
        let full14Set = new Set(full14);
        middle = rankedMain.filter(num => !basketSet.has(num) && !full14Set.has(num));
        middle = [...middle, ...replacedOut].filter((v,i,a)=>a.indexOf(v)===i).sort((a,b)=>a-b);

        // í•©ê³„ ê³„ì‚°
        const targetRounds = [];
        for (let i = 1; i <= referenceCount; i++) {
            targetRounds.push(targetRound - intervalWeeks * i);
        }
        let sums = targetRounds.map(r => {
            let row = FULL_DATA.find(x => x[0] === r);
            return row ? row.slice(1,7).reduce((a,b)=>a+b,0) : 0;
        }).filter(s => s > 0);
        dynamicAvgSum = sums.length ? Math.round(sums.reduce((a,b)=>a+b,0) / sums.length) : 145;

        // UI ì—…ë°ì´íŠ¸
        const baseNums = prevData.slice(1, 7);
        const bonus = prevData[7];
        let ballHtml = baseNums.map(n => `<span class="base-num-box">${n}</span>`).join('');
        ballHtml += `<span class="bonus-label">ë³´ë„ˆìŠ¤</span>`;
        ballHtml += `<span class="base-num-box">${bonus}</span>`;
        document.getElementById('baseRoundInfo').innerHTML = ballHtml;
        document.getElementById('prevWinLabel').innerHTML = `ğŸ“Œ ${prevRound}íšŒ ë‹¹ì²¨ë²ˆí˜¸`;
        document.getElementById('roundDisplay').innerHTML = `ì˜ˆìƒ ${targetRound}íšŒì°¨`;
        document.getElementById('targetRound').innerText = targetRound;

        let replacedInHtml = replacedIn.length ? replacedIn.map(n => `<span class="replaced-in">${n}</span>`).join(', ') : 'ì—†ìŒ';
        let replacedOutHtml = replacedOut.length ? replacedOut.map(n => `<span class="replaced-out">${n}</span>`).join(', ') : 'ì—†ìŒ';
        let compressedOutHtml = compressedOut4.map(n => 
            replacedIn.includes(n) ? `<span class="replaced-in">${n}</span>` : n
        ).join(', ');

        document.getElementById('status').innerHTML = `
            <div><span class="highlight-gold">â˜… ì••ì¶•ìˆ˜ ${currentCompress} / ê°„ê²© ${intervalWeeks}ì£¼ / ${referenceCount}ê°œ íšŒì°¨</span></div>
            <div>ìƒì¡´ì ${survivors.length}ìˆ˜: ${survivors.join(', ')}</div>
            <div>AI ì¶”ì²œ ${basket.length}ìˆ˜: ${basket.join(', ')}</div>
            <div>ğŸ”» 14ìˆ˜ì—ì„œ ë¹ ì§„ ${compressedOut4.length}ê°œ (êµì²´ í›„ ë‚¨ì€): ${compressedOutHtml}</div>
            <div style="margin-top:4px;">
                <span style="color:#ff6666;">â–¶ êµì²´ëœ ë²ˆí˜¸: ${replacedInHtml}</span><br>
                <span style="color:#66aaff;">â—€ êµì²´ë‹¹í•œ ë²ˆí˜¸: ${replacedOutHtml}</span><br>
                <span style="color:#aaa;">ğŸ“¦ B bag: ${middle.join(', ') || 'ì—†ìŒ'}</span>
            </div>
            <div><span class="highlight-blue">ğŸ“Š ê¸°ì¤€ í•©ê³„ í‰ê· :</span> ${dynamicAvgSum} (ì°¸ê³ ìš©)</div>
        `;

        document.getElementById('reviewTitle').innerHTML = `ğŸ“Š ${targetRound}íšŒ ë³µê¸°`;
        document.getElementById('reviewDesc').innerHTML = `${targetRound}íšŒ ë‹¹ì²¨ë²ˆí˜¸ 6ê°œ + ë³´ë„ˆìŠ¤ ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”`;

        const reviewAIInfo = document.getElementById('reviewAIInfo');
        if (reviewAIInfo) {
            reviewAIInfo.innerHTML = `
                <div><span class="highlight-blue">ìƒì¡´ì ${survivors.length}ìˆ˜:</span> ${survivors.join(', ')}</div>
                <div><span class="highlight-gold">AI ì¶”ì²œ ${basket.length}ìˆ˜:</span> ${basket.join(', ')}</div>
                <div><span class="highlight-blue">ğŸ”» 14ìˆ˜ì—ì„œ ë¹ ì§„ ${compressedOut4.length}ê°œ (êµì²´ í›„ ë‚¨ì€):</span> ${compressedOutHtml}</div>
                <div><span style="color:#ff6666;">â–¶ êµì²´ëœ ë²ˆí˜¸: ${replacedInHtml}</span></div>
                <div><span style="color:#66aaff;">â—€ êµì²´ë‹¹í•œ ë²ˆí˜¸: ${replacedOutHtml}</span></div>
                <div><span style="color:#aaa;">ğŸ“¦ B bag: ${middle.join(', ') || 'ì—†ìŒ'}</span></div>
            `;
        }
    }

    function setBaseRound() {
        const input = document.getElementById('baseRoundInput').value;
        const round = parseInt(input);
        if (isNaN(round) || round < 901 || round > 1300) {
            alert('901~1300 ì‚¬ì´ì˜ íšŒì°¨ë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
            return;
        }
        currentBaseRound = round;
        analyze();
    }

    // ===== ì¡°í•© ìƒì„± í•¨ìˆ˜ (í”Œë˜ê·¸ ì ìš©) =====
    function process(limit) {
        if (!isIntegratedState) {
            analyze(); // í‘œì¤€ ë¶„ì„ ìƒíƒœì—ì„œë§Œ ì‹¤í–‰
        }
        generatedCombos = [];
        let used = new Set();

        if (limit === 10) {
            for (let i = 0; i < limit; i++) {
                let combo = new Set();
                let pool = (i % 2 === 0) ? full14 : basket;
                let available = [...pool];

                let special = null;
                if (compressedOut4.length > 0) {
                    special = compressedOut4[Math.floor(Math.random() * compressedOut4.length)];
                    combo.add(special);
                    available = available.filter(n => n !== special);
                }

                let shuffled = available.sort(() => Math.random() - 0.5);
                for (let n of shuffled) {
                    if (combo.size < 6) combo.add(n);
                }

                if (combo.size < 6) {
                    let all = [...new Set([...pool, ...compressedOut4])];
                    let shuffledAll = all.sort(() => Math.random() - 0.5);
                    for (let n of shuffledAll) {
                        combo.add(n);
                        if (combo.size === 6) break;
                    }
                }

                let finalArr = Array.from(combo).sort((a,b)=>a-b);
                let key = finalArr.join(',');
                if (!used.has(key)) {
                    used.add(key);
                    generatedCombos.push({ numbers: finalArr, key: key, comboNumber: i + 1 });
                } else {
                    if (i < limit) limit++;
                    if (limit > 100) break;
                }
            }
        } else {
            // 5ì¡°í•© ë° ì‚¬ìš©ì ì§€ì •: ê°€ì¤‘ì¹˜ ê¸°ë°˜ ëœë¤ (ëˆ„ì  í™•ë¥  ë°©ì‹)
            let count = 0, safety = 0;
            while (count < limit && safety < 50000) {
                safety++;
                let res = new Set();
                // ê°€ì¤‘ì¹˜ ëª©ë¡ ìƒì„±
                let weightedItems = basket.map(n => ({ num: n, weight: weightedScore[n] || 1 }));
                // ê°€ì¤‘ì¹˜ ëœë¤ ì„ íƒ (ë¹„ë³µì› ì¶”ì¶œ)
                while (res.size < 6 && weightedItems.length > 0) {
                    let total = weightedItems.reduce((sum, item) => sum + item.weight, 0);
                    let rand = Math.random() * total;
                    let cum = 0;
                    for (let i = 0; i < weightedItems.length; i++) {
                        cum += weightedItems[i].weight;
                        if (rand < cum) {
                            res.add(weightedItems[i].num);
                            weightedItems.splice(i, 1);
                            break;
                        }
                    }
                }
                // ë¶€ì¡±í•˜ë©´ ëœë¤ ë³´ì¶© (ê±°ì˜ ë°œìƒ ì•ˆ í•¨)
                while (res.size < 6) {
                    let rand = basket[Math.floor(Math.random() * basket.length)];
                    res.add(rand);
                }
                let finalArr = Array.from(res).sort((a,b)=>a-b);
                let key = finalArr.join(',');
                if (!used.has(key)) {
                    used.add(key);
                    count++;
                    generatedCombos.push({ numbers: finalArr, key: key, comboNumber: count });
                }
            }
        }
        showComboList();
    }

    function showComboList() {
        const content = document.getElementById('comboListContent');
        if (generatedCombos.length === 0) {
            content.innerHTML = '<div style="text-align:center; padding:12px;">ìƒì„±ëœ ì¡°í•©ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
            document.getElementById('comboListPopup').style.display = 'flex';
            return;
        }
        let html = '';
        generatedCombos.forEach(combo => {
            const numberSpans = combo.numbers.map(n => {
                let className = 'num-box';
                if (replacedIn.includes(n)) className += ' replaced-in';
                else if (replacedOut.includes(n)) className += ' replaced-out';
                else if (survivors.includes(n) && !basket.includes(n)) className += ' eliminated';
                return `<span class="${className}" style="width:24px; height:24px; line-height:24px; font-size:10px;">${n}</span>`;
            }).join('');
            html += `<div class="combo-item-row"><div class="combo-nums">${numberSpans}</div><div><button class="combo-save-btn" onclick="saveComboFromList('${combo.key}')">ì €ì¥</button></div></div>`;
        });
        content.innerHTML = html;
        document.getElementById('comboListPopup').style.display = 'flex';
    }

    function saveComboFromList(key) {
        saveToBox(key);
    }

    function closeComboListPopup() {
        document.getElementById('comboListPopup').style.display = 'none';
    }

    // ===== ì—°ì† ë¶„ì„ (ê°œë³„ íšŒì°¨ë³„, ê³¼ê±° ë°©í–¥) =====
    function runBatchAnalysis() {
        const startRound = currentBaseRound;
        const count = parseInt(document.getElementById('batchCount').value) || 10;
        if (count < 1 || count > 30) {
            alert('1~30 ì‚¬ì´ì˜ íšŸìˆ˜ë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
            return;
        }

        const results = [];
        for (let i = 0; i < count; i++) {
            const targetRound = startRound - i;
            const pastRounds = [];
            for (let j = 1; j <= referenceCount; j++) {
                pastRounds.push(targetRound - intervalWeeks * j);
            }
            const valid = pastRounds.every(r => FULL_DATA.some(row => row[0] === r));
            if (!valid) continue;

            const res = computeForRound(targetRound, currentCompress);
            results.push({
                round: targetRound,
                basket: res.basket,
                survivors: res.survivors,
                compressedOut: res.compressedOut,
                full14: res.full14
            });
        }

        if (results.length === 0) {
            alert('ë¶„ì„ ê°€ëŠ¥í•œ íšŒì°¨ê°€ ì—†ìŠµë‹ˆë‹¤. ê¸°ì¤€ íšŒì°¨ë¥¼ ë†’ì´ì„¸ìš”.');
            return;
        }
        showBatchResults(results);
    }

    function showBatchResults(results) {
        let html = `
            <div style="max-height:70vh; overflow-y:auto; font-size:12px;">
                <table style="width:100%; border-collapse:collapse; background:#1a1a1a;">
                    <thead><tr style="background:#333; color:var(--gold);"><th>íšŒì°¨</th><th>AI ${currentCompress}ìˆ˜</th><th>ìƒì¡´ì ìˆ˜</th><th>ë¹ ì§„ ë²ˆí˜¸</th></tr></thead>
                    <tbody>
        `;
        results.forEach(r => {
            html += `<tr style="border-bottom:1px solid #444;">
                <td style="padding:6px; text-align:center; font-weight:bold;">${r.round}</td>
                <td style="padding:6px;">${r.basket.join(', ')}</td>
                <td style="padding:6px; text-align:center;">${r.survivors.length}</td>
                <td style="padding:6px; color:#ff8888;">${r.compressedOut.join(', ') || '-'}</td>
            </tr>`;
        });
        html += `</tbody></table></div>
            <div style="display:flex; gap:8px; justify-content:center; margin-top:12px;">
                <button class="game-btn" onclick="copyBatchResults(${JSON.stringify(results).replace(/"/g, '&quot;')})">ğŸ“‹ ê²°ê³¼ ë³µì‚¬</button>
                <button class="game-btn" onclick="this.closest('.popup-overlay').remove()">ë‹«ê¸°</button>
            </div>`;

        const popup = document.createElement('div');
        popup.className = 'popup-overlay';
        popup.innerHTML = `<div class="popup-content" style="max-width:650px;">${html}</div>`;
        document.body.appendChild(popup);
        popup.addEventListener('click', e => { if (e.target === popup) popup.remove(); });
    }

    function copyBatchResults(results) {
        let text = 'íšŒì°¨\tAI ìˆ˜\tìƒì¡´ì ìˆ˜\të¹ ì§„ ë²ˆí˜¸\n';
        results.forEach(r => {
            text += `${r.round}\t${r.basket.join(',')}\t${r.survivors.length}\t${r.compressedOut.join(',')}\n`;
        });
        navigator.clipboard.writeText(text).then(() => alert('âœ… ê²°ê³¼ ë³µì‚¬ë¨')).catch(() => alert('âŒ ë³µì‚¬ ì‹¤íŒ¨'));
    }

    // ===== í†µí•© ë¶„ì„ í•¨ìˆ˜ (ì—¬ëŸ¬ íšŒì°¨ í†µí•©) =====
    function runIntegratedAnalysis() {
        const startRound = currentBaseRound;
        const count = parseInt(document.getElementById('batchCount').value) || 10;
        if (count < 1 || count > 30) {
            alert('1~30 ì‚¬ì´ì˜ íšŸìˆ˜ë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
            return;
        }

        // ê¸°ì¤€ íšŒì°¨ì˜ ì‹¤ì œ ë‹¹ì²¨ë²ˆí˜¸ ê°€ì ¸ì˜¤ê¸°
        const winData = FULL_DATA.find(row => row[0] === startRound);
        let winningNums = [], bonusNum = null;
        if (winData) {
            winningNums = winData.slice(1, 7);
            bonusNum = winData[7];
        }

        // 1. ë°ì´í„° ìˆ˜ì§‘ - startRoundëŠ” ì œì™¸í•˜ê³  ê·¸ ì´ì „ íšŒì°¨ë§Œ ìˆ˜ì§‘
        let allMain = [];
        let allBonus = [];
        let mainWithRound = [];
        
        // i=1ë¶€í„° ì‹œì‘í•´ì„œ startRound ì´ì „ íšŒì°¨ë§Œ ìˆ˜ì§‘
        for (let i = 1; i <= count; i++) {
            const round = startRound - i; // startRound-1, startRound-2, ...
            const row = FULL_DATA.find(x => x[0] === round);
            if (row) {
                const mainNums = row.slice(1, 7);
                const bonus = row[7];
                mainNums.forEach(n => {
                    allMain.push(n);
                    const weight = 1.6 - (i-1) * 0.1; // i=1ì¼ë•Œ 1.6, i=2ì¼ë•Œ 1.5, ...
                    mainWithRound.push({ num: n, round: round, weight: Math.max(0.1, weight) });
                });
                allBonus.push(bonus);
            }
        }

        if (allMain.length === 0) {
            alert('ë¶„ì„ ê°€ëŠ¥í•œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
            return;
        }

        // 2. ë¯¸ì¶œìˆ˜ ê³„ì‚° (ìµœê·¼ 22íšŒì°¨ - startRound ì œì™¸)
        let freq22 = {};
        for(let i=1; i<=45; i++) freq22[i] = 0;
        
        // startRound ì´í›„ì˜ ë°ì´í„°ëŠ” ì œì™¸í•˜ê³  ìµœê·¼ 22íšŒì°¨ ê³„ì‚°
        const recentData = FULL_DATA.filter(row => row[0] < startRound).slice(0, 22);
        recentData.forEach(row => {
            for(let j=1; j<=7; j++) if(row[j]) freq22[row[j]]++;
        });
        let zeroFreq = Object.keys(freq22).filter(n => freq22[n]===0).map(Number);

        // 3. ê°€ì¤‘ì¹˜ ì ìˆ˜
        let wScore = {};
        mainWithRound.forEach(item => {
            wScore[item.num] = (wScore[item.num] || 0) + item.weight;
        });
        zeroFreq.forEach(num => {
            if (wScore[num] !== undefined) wScore[num] += 0.2;
        });

        // 4. ì ìˆ˜ìˆœ ì •ë ¬
        let rankedMain = Object.keys(wScore).map(Number).sort((a, b) => {
            let aScore = wScore[a] || 0;
            let bScore = wScore[b] || 0;
            if (aScore > bScore) return -1;
            if (aScore < bScore) return 1;
            return a - b;
        });

        // 5. ê³ ì • 14ìˆ˜
        let top8 = rankedMain.slice(0, 8);
        let bottom6 = rankedMain.slice(-6);
        let full14Set = new Set([...top8, ...bottom6]);
        let full14 = Array.from(full14Set).sort((a,b)=>a-b);

        // 6. ì••ì¶•ìˆ˜ basket
        let topCount = Math.floor(currentCompress * 0.6);
        let bottomCount = currentCompress - topCount;
        topCount = Math.min(topCount, rankedMain.length);
        bottomCount = Math.min(bottomCount, rankedMain.length - topCount);
        let topPart = rankedMain.slice(0, topCount);
        let bottomPart = rankedMain.slice(-bottomCount);
        let basketSet = new Set([...topPart, ...bottomPart]);
        let basket = Array.from(basketSet).sort((a,b)=>a-b);

        // 7. ìƒì¡´ì
        let survivorsSet = new Set([...allMain, ...allBonus]);
        let survivors = Array.from(survivorsSet).sort((a,b)=>a-b);

        // 8. ë¹ ì§„ 4ê°œ
        let compressedOut = full14.filter(num => !basketSet.has(num));

        // 9. êµì²´ ë¡œì§ (ì§ì „ íšŒì°¨ ë‹¹ì²¨ë²ˆí˜¸)
        const prevRound = startRound - 1;
        const prevData = FULL_DATA.find(row => row[0] === prevRound);
        const lastWinning = prevData ? prevData.slice(1, 7) : [];

        let candidates = compressedOut.filter(num => lastWinning.includes(num));
        if (candidates.length < 2) {
            let sortedOut = [...compressedOut].sort((a, b) => (wScore[b] || 0) - (wScore[a] || 0));
            for (let num of sortedOut) {
                if (!candidates.includes(num) && candidates.length < 2) {
                    candidates.push(num);
                }
            }
        }
        candidates = [...new Set(candidates)].slice(0, 2);

        let lowestTwo = [];
        if (candidates.length > 0) {
            let basketWithScore = basket.map(num => ({ num, score: wScore[num] || 0 }));
            basketWithScore.sort((a, b) => a.score - b.score);
            lowestTwo = basketWithScore.slice(0, candidates.length).map(item => item.num);

            let newBasket = [...basket];
            for (let i = 0; i < candidates.length; i++) {
                let idx = newBasket.indexOf(lowestTwo[i]);
                if (idx !== -1) {
                    newBasket[idx] = candidates[i];
                }
            }
            newBasket = [...new Set(newBasket)].sort((a, b) => a - b);
            if (newBasket.length === basket.length) {
                basket = newBasket;
                compressedOut = full14.filter(num => !new Set(basket).has(num));
            }
        }

        let replacedIn = candidates;
        let replacedOut = lowestTwo;
        let middleBag = rankedMain.filter(num => !new Set(basket).has(num) && !new Set(full14).has(num));
        middleBag = [...middleBag, ...replacedOut].filter((v,i,a)=>a.indexOf(v)===i).sort((a,b)=>a-b);

        // 10. í†µí•© ê²°ê³¼ ê°ì²´ ìƒì„±
        const integratedResult = {
            range: `${startRound} ~ ${startRound - count + 1}íšŒ í†µí•©`,
            basket: basket,
            survivors: survivors,
            compressedOut: compressedOut,
            full14: full14,
            replacedIn: replacedIn,
            replacedOut: replacedOut,
            middleBag: middleBag,
            compress: currentCompress,
            weightedScore: wScore,
            winningNums: winningNums,
            bonusNum: bonusNum,
            targetRound: startRound
        };

        // 11. íŒì—… í‘œì‹œ
        showIntegratedPopup(integratedResult);
    }

    function showIntegratedPopup(data) {
        const winSet = new Set(data.winningNums || []);
        if (data.bonusNum) winSet.add(data.bonusNum);

        // ìˆ«ì í‘œì‹œ í•¨ìˆ˜: ë°°ê²½/í…Œë‘ë¦¬ ì—†ì´ ìƒ‰ìƒë§Œ ì ìš©
        const formatNumber = (num) => {
            let color = '#ffd700'; // ê¸°ë³¸ ê¸ˆìƒ‰
            if (winSet.has(num)) color = '#00ff00';
            else if (data.replacedIn.includes(num)) color = '#ff6666';
            else if (data.replacedOut.includes(num)) color = '#66aaff';
            else if (data.survivors.includes(num) && !data.basket.includes(num)) color = '#aaa';
            return `<span style="display:inline-block; padding:0 2px; color:${color};">${num}</span>`;
        };

        let replacedInHtml = data.replacedIn.length ? data.replacedIn.map(n => formatNumber(n)).join(' ') : 'ì—†ìŒ';
        let replacedOutHtml = data.replacedOut.length ? data.replacedOut.map(n => formatNumber(n)).join(' ') : 'ì—†ìŒ';
        let survivorsHtml = data.survivors.map(n => formatNumber(n)).join(' ');
        let basketHtml = data.basket.map(n => formatNumber(n)).join(' ');
        let compressedOutHtml = data.compressedOut.map(n => formatNumber(n)).join(' ');
        let middleBagHtml = data.middleBag.length ? data.middleBag.map(n => formatNumber(n)).join(' ') : 'ì—†ìŒ';

        let winningHtml = '';
        if (data.winningNums && data.winningNums.length === 6) {
            winningHtml = `
                <div style="text-align:center; margin:8px 0; padding:4px; background:#222; border-radius:6px;">
                    <span class="highlight-gold">ğŸ“Œ ${data.targetRound}íšŒ ë‹¹ì²¨ë²ˆí˜¸:</span> 
                    ${data.winningNums.map(n => `<span style="display:inline-block; padding:0 2px; color:#ffd700;">${n}</span>`).join('')}
                    <span class="bonus-label">ë³´ë„ˆìŠ¤</span>
                    <span style="display:inline-block; padding:0 2px; color:#ffd700;">${data.bonusNum}</span>
                </div>
            `;
        }

        let html = `
            <div style="font-size:12px; background:#1a1a1a; border-radius:8px; padding:10px;">
                <div style="text-align:center; margin-bottom:8px; color:var(--accent); font-weight:bold;">ğŸ“Š ${data.range}</div>
                ${winningHtml}
                <div><span class="highlight-gold">â˜… ì••ì¶•ìˆ˜ ${data.compress}</span></div>
                <div>ìƒì¡´ì ${data.survivors.length}ìˆ˜: ${survivorsHtml}</div>
                <div>AI ì¶”ì²œ ${data.basket.length}ìˆ˜: ${basketHtml}</div>
                <div>ğŸ”» 14ìˆ˜ì—ì„œ ë¹ ì§„ ${data.compressedOut.length}ê°œ (êµì²´ í›„ ë‚¨ì€): ${compressedOutHtml}</div>
                <div style="margin-top:4px;">
                    <span style="color:#ff6666;">â–¶ êµì²´ëœ ë²ˆí˜¸: ${replacedInHtml}</span><br>
                    <span style="color:#66aaff;">â—€ êµì²´ë‹¹í•œ ë²ˆí˜¸: ${replacedOutHtml}</span><br>
                    <span style="color:#aaa;">ğŸ“¦ B bag: ${middleBagHtml}</span>
                </div>
            </div>
            <div style="display:flex; gap:8px; justify-content:center; margin-top:12px;">
                <button class="game-btn" onclick="applyIntegratedResult('${encodeURIComponent(JSON.stringify(data))}')">âœ… ì´ ê²°ê³¼ ì ìš©</button>
                <button class="game-btn" onclick="this.closest('.popup-overlay').remove()">ë‹«ê¸°</button>
            </div>
        `;

        const popup = document.createElement('div');
        popup.className = 'popup-overlay';
        popup.innerHTML = `<div class="popup-content" style="max-width:450px;">${html}</div>`;
        document.body.appendChild(popup);
        popup.addEventListener('click', e => { if (e.target === popup) popup.remove(); });
    }

    // í†µí•© ê²°ê³¼ë¥¼ í˜„ì¬ ë¶„ì„ ìƒíƒœì— ì ìš©
    function applyIntegratedResult(encodedData) {
        try {
            const data = JSON.parse(decodeURIComponent(encodedData));
            
            basket = data.basket;
            survivors = data.survivors;
            compressedOut4 = data.compressedOut;
            full14 = data.full14;
            replacedIn = data.replacedIn;
            replacedOut = data.replacedOut;
            middle = data.middleBag;
            weightedScore = data.weightedScore;

            isIntegratedState = true; // í†µí•© ìƒíƒœ í”Œë˜ê·¸ ì„¤ì •

            const targetRound = currentBaseRound;
            const prevRound = targetRound - 1;
            const prevData = FULL_DATA.find(row => row[0] === prevRound);
            
            // ì´ì „ íšŒì°¨ ë‹¹ì²¨ë²ˆí˜¸ í‘œì‹œ
            if (prevData) {
                const baseNums = prevData.slice(1, 7);
                const bonus = prevData[7];
                let ballHtml = baseNums.map(n => `<span class="base-num-box">${n}</span>`).join('');
                ballHtml += `<span class="bonus-label">ë³´ë„ˆìŠ¤</span>`;
                ballHtml += `<span class="base-num-box">${bonus}</span>`;
                document.getElementById('baseRoundInfo').innerHTML = ballHtml;
            }

            let replacedInHtml = replacedIn.length ? replacedIn.map(n => `<span class="replaced-in">${n}</span>`).join(', ') : 'ì—†ìŒ';
            let replacedOutHtml = replacedOut.length ? replacedOut.map(n => `<span class="replaced-out">${n}</span>`).join(', ') : 'ì—†ìŒ';
            let compressedOutHtml = compressedOut4.map(n => 
                replacedIn.includes(n) ? `<span class="replaced-in">${n}</span>` : n
            ).join(', ');

            // ë©”ì¸ ìƒíƒœì°½ ì—…ë°ì´íŠ¸
            document.getElementById('status').innerHTML = `
                <div><span class="highlight-gold">â˜… [í†µí•© ì ìš©] ì••ì¶•ìˆ˜ ${currentCompress}</span></div>
                <div>ìƒì¡´ì ${survivors.length}ìˆ˜: ${survivors.join(', ')}</div>
                <div>AI ì¶”ì²œ ${basket.length}ìˆ˜: ${basket.join(', ')}</div>
                <div>ğŸ”» 14ìˆ˜ì—ì„œ ë¹ ì§„ ${compressedOut4.length}ê°œ (êµì²´ í›„ ë‚¨ì€): ${compressedOutHtml}</div>
                <div style="margin-top:4px;">
                    <span style="color:#ff6666;">â–¶ êµì²´ëœ ë²ˆí˜¸: ${replacedInHtml}</span><br>
                    <span style="color:#66aaff;">â—€ êµì²´ë‹¹í•œ ë²ˆí˜¸: ${replacedOutHtml}</span><br>
                    <span style="color:#aaa;">ğŸ“¦ B bag: ${middle.join(', ') || 'ì—†ìŒ'}</span>
                </div>
                <div><span class="highlight-blue">ğŸ“Š (í†µí•© ë¶„ì„ ê²°ê³¼ ì ìš©ë¨)</span></div>
            `;

            // reviewAIInfo ì—…ë°ì´íŠ¸ - ë³µê¸°ì°½ì— í‘œì‹œë  ë‚´ìš©
            const reviewAIInfo = document.getElementById('reviewAIInfo');
            if (reviewAIInfo) {
                reviewAIInfo.innerHTML = `
                    <div><span class="highlight-blue">ìƒì¡´ì ${survivors.length}ìˆ˜:</span> ${survivors.join(', ')}</div>
                    <div><span class="highlight-gold">AI ì¶”ì²œ ${basket.length}ìˆ˜:</span> ${basket.join(', ')}</div>
                    <div><span class="highlight-blue">ğŸ”» 14ìˆ˜ì—ì„œ ë¹ ì§„ ${compressedOut4.length}ê°œ (êµì²´ í›„ ë‚¨ì€):</span> ${compressedOutHtml}</div>
                    <div><span style="color:#ff6666;">â–¶ êµì²´ëœ ë²ˆí˜¸: ${replacedInHtml}</span></div>
                    <div><span style="color:#66aaff;">â—€ êµì²´ë‹¹í•œ ë²ˆí˜¸: ${replacedOutHtml}</span></div>
                    <div><span style="color:#aaa;">ğŸ“¦ B bag: ${middle.join(', ') || 'ì—†ìŒ'}</span></div>
                `;
            }

            // ë³µê¸° íŒì—… ì œëª© ì—…ë°ì´íŠ¸
            document.getElementById('reviewTitle').innerHTML = `ğŸ“Š ${targetRound}íšŒ ë³µê¸°`;
            document.getElementById('reviewDesc').innerHTML = `${targetRound}íšŒ ë‹¹ì²¨ë²ˆí˜¸ 6ê°œ + ë³´ë„ˆìŠ¤ ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”`;
            
            // íŒì—… ë‹«ê¸°
            const popup = document.querySelector('.popup-overlay');
            if (popup) popup.remove();
            
            showToast('í†µí•© ë¶„ì„ ê²°ê³¼ê°€ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤. 5/10ì¡°í•©ì„ ìƒì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
        } catch(e) {
            alert('ë°ì´í„° ì ìš© ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            console.error(e);
        }
    }

    // ===== íŒì—… í•¨ìˆ˜ =====
    function openPopup() { document.getElementById('popup').style.display = 'flex'; renderStorage(); }
    function closePopup() { document.getElementById('popup').style.display = 'none'; }
    function clearStorage() {
        if(confirm("ë³´ê´€í•¨ì„ ì´ˆê¸°í™”í• ê¹Œìš”?")) {
            savedNumbers = [];
            generatedCombos = [];
            localStorage.removeItem(`lottoSave_${userName}`);
            renderStorage();
            showToast('ğŸ—‘ï¸ ë³´ê´€í•¨ ì´ˆê¸°í™”ë¨');
        }
    }

    // ===== ê²Œì„ í•¨ìˆ˜ =====
    function openGamePopup() {
        document.getElementById('gamePopup').style.display = 'flex';
        setTimeout(() => {
            initTouchGame();
            resetTouchGame();
            resetReactionGame();
        }, 100);
    }
    function closeGamePopup() { document.getElementById('gamePopup').style.display = 'none'; }
    function switchGame(game) {
        document.querySelectorAll('.game-tab').forEach(t => t.classList.remove('active'));
        document.querySelector(`.game-tab[data-game="${game}"]`).classList.add('active');
        document.querySelectorAll('.game-panel').forEach(p => p.classList.remove('active'));
        document.getElementById(game + 'Game').classList.add('active');
    }

    // í„°ì¹˜ ëŸ¬ì‰¬ ê²Œì„
    function initTouchGame() {
        const canvas = document.getElementById('gameCanvas');
        if (!canvas) return;
        const ctx = canvas.getContext('2d');
        canvas.width = canvas.clientWidth;
        canvas.height = canvas.clientHeight;
        
        const balls = [];
        for (let i = 1; i <= 45; i++) {
            balls.push({
                num: i,
                x: Math.random() * (canvas.width - 40) + 20,
                y: Math.random() * (canvas.height - 40) + 20,
                vx: (Math.random() - 0.5) * 2,
                vy: (Math.random() - 0.5) * 2,
                radius: 16
            });
        }

        if (touchInterval) clearInterval(touchInterval);
        touchInterval = setInterval(() => {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            balls.forEach(ball => {
                ball.x += ball.vx;
                ball.y += ball.vy;
                if (ball.x < ball.radius || ball.x > canvas.width - ball.radius) ball.vx *= -1;
                if (ball.y < ball.radius || ball.y > canvas.height - ball.radius) ball.vy *= -1;
                
                ctx.beginPath();
                ctx.arc(ball.x, ball.y, ball.radius, 0, Math.PI * 2);
                ctx.fillStyle = touchSelected.includes(ball.num) ? '#ffd700' : '#333';
                ctx.fill();
                ctx.strokeStyle = touchSelected.includes(ball.num) ? '#fff' : '#ffd700';
                ctx.lineWidth = 2;
                ctx.stroke();
                ctx.fillStyle = touchSelected.includes(ball.num) ? '#000' : '#ffd700';
                ctx.font = 'bold 10px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(ball.num, ball.x, ball.y);
            });
        }, 30);

        canvas.onclick = (e) => {
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            const mouseX = (e.clientX - rect.left) * scaleX;
            const mouseY = (e.clientY - rect.top) * scaleY;
            
            balls.forEach(ball => {
                const dist = Math.hypot(mouseX - ball.x, mouseY - ball.y);
                if (dist < ball.radius) {
                    if (touchSelected.includes(ball.num)) {
                        touchSelected = touchSelected.filter(n => n !== ball.num);
                    } else if (touchSelected.length < 6) {
                        touchSelected.push(ball.num);
                    }
                }
            });
            updateSelectedDisplay();
        };
        touchGame = { balls };
    }

    function resetTouchGame() {
        touchSelected = [];
        updateSelectedDisplay();
        document.getElementById('saveComboBtn').disabled = true;
    }

    function updateSelectedDisplay() {
        const container = document.getElementById('selectedNumbersContainer');
        container.innerHTML = touchSelected.map(n => `<span class="selected-ball">${n}</span>`).join('');
        document.getElementById('saveComboBtn').disabled = touchSelected.length !== 6;
    }

    function saveTouchCombo() {
        if (touchSelected.length === 6) {
            const sorted = [...touchSelected].sort((a,b)=>a-b);
            saveToBox(sorted.join(','));
            resetTouchGame();
        }
    }

    // ë°˜ì‘ì†ë„ ê²Œì„
    function startReaction() {
        const box = document.getElementById('reactionBox');
        const result = document.getElementById('reactionResult');
        box.style.background = '#222';
        box.innerText = 'ì´ˆë¡ìƒ‰ì´ ë˜ë©´ ëˆ„ë¥´ì„¸ìš”';
        result.innerText = '';
        reactionState = 'waiting';
        
        setTimeout(() => {
            if (reactionState === 'waiting') {
                box.style.background = '#00cc66';
                box.innerText = 'ì§€ê¸ˆ!';
                reactionState = 'ready';
                reactionStartTime = Date.now();
                
                // 2ì´ˆ í›„ íƒ€ì„ì•„ì›ƒ
                setTimeout(() => {
                    if (reactionState === 'ready') {
                        box.style.background = '#ff4444';
                        box.innerText = 'ë„ˆë¬´ ëŠ¦ìŒ';
                        reactionState = 'idle';
                    }
                }, 2000);
            }
        }, Math.random() * 2000 + 1000);
    }

    function handleReactionClick() {
        const box = document.getElementById('reactionBox');
        const result = document.getElementById('reactionResult');
        
        if (reactionState === 'ready') {
            const reactionTime = Date.now() - reactionStartTime;
            box.style.background = '#333';
            box.innerText = `${reactionTime}ms`;
            result.innerText = `ë°˜ì‘ì‹œê°„: ${reactionTime}ms`;
            reactionState = 'idle';
            
            // ëœë¤ ë²ˆí˜¸ 6ê°œ ìƒì„±
            const nums = [];
            while(nums.length < 6) {
                const r = Math.floor(Math.random() * 45) + 1;
                if (!nums.includes(r)) nums.push(r);
            }
            reactionSelected = nums.sort((a,b)=>a-b);
            document.getElementById('reactionSelectedContainer').innerHTML = 
                reactionSelected.map(n => `<span class="selected-ball">${n}</span>`).join('');
            document.getElementById('saveReactionBtn').disabled = false;
        } else if (reactionState === 'waiting') {
            box.style.background = '#ff4444';
            box.innerText = 'ì„±ê¸‰í•¨!';
            reactionState = 'idle';
        }
    }

    function resetReactionGame() {
        reactionSelected = [];
        document.getElementById('reactionSelectedContainer').innerHTML = '';
        document.getElementById('reactionBox').innerHTML = 'ì‹œì‘í•˜ë ¤ë©´ ëˆ„ë¥´ì„¸ìš”';
        document.getElementById('reactionBox').style.background = '#222';
        document.getElementById('reactionResult').innerHTML = '';
        document.getElementById('saveReactionBtn').disabled = true;
        reactionState = 'idle';
    }

    function saveReactionCombo() {
        if (reactionSelected.length === 6) {
            saveToBox(reactionSelected.join(','));
            resetReactionGame();
        }
    }

    // ===== ë³µê¸° í•¨ìˆ˜ =====
    function openReviewPopup() {
        analyze(); // ë°ì´í„° ë¡œë“œ - ì´ê±° ì¶”ê°€!
        
        const targetRound = currentBaseRound;
        const winData = FULL_DATA.find(row => row[0] === targetRound);
        const winningDisplay = document.getElementById('winningDisplay');
        
        // reviewAIInfo ì—…ë°ì´íŠ¸ - í˜„ì¬ ìƒíƒœ ë°˜ì˜
        const reviewAIInfo = document.getElementById('reviewAIInfo');
        if (reviewAIInfo) {
            let replacedInHtml = replacedIn.length ? replacedIn.map(n => `<span class="replaced-in">${n}</span>`).join(', ') : 'ì—†ìŒ';
            let replacedOutHtml = replacedOut.length ? replacedOut.map(n => `<span class="replaced-out">${n}</span>`).join(', ') : 'ì—†ìŒ';
            let compressedOutHtml = compressedOut4.map(n => 
                replacedIn.includes(n) ? `<span class="replaced-in">${n}</span>` : n
            ).join(', ');

            reviewAIInfo.innerHTML = `
                <div><span class="highlight-blue">ìƒì¡´ì ${survivors.length}ìˆ˜:</span> ${survivors.join(', ')}</div>
                <div><span class="highlight-gold">AI ì¶”ì²œ ${basket.length}ìˆ˜:</span> ${basket.join(', ')}</div>
                <div><span class="highlight-blue">ğŸ”» 14ìˆ˜ì—ì„œ ë¹ ì§„ ${compressedOut4.length}ê°œ (êµì²´ í›„ ë‚¨ì€):</span> ${compressedOutHtml}</div>
                <div><span style="color:#ff6666;">â–¶ êµì²´ëœ ë²ˆí˜¸: ${replacedInHtml}</span></div>
                <div><span style="color:#66aaff;">â—€ êµì²´ë‹¹í•œ ë²ˆí˜¸: ${replacedOutHtml}</span></div>
                <div><span style="color:#aaa;">ğŸ“¦ B bag: ${middle.join(', ') || 'ì—†ìŒ'}</span></div>
            `;
        }

        if (winData) {
            const nums = winData.slice(1, 7).join(', ');
            const bonus = winData[7];
            winningDisplay.innerHTML = `ğŸ“Œ ${targetRound}íšŒ ë‹¹ì²¨ë²ˆí˜¸: ${nums} + ë³´ë„ˆìŠ¤ ${bonus}`;
            
            // ë‹¹ì²¨ë²ˆí˜¸ ìë™ ì…ë ¥
            for (let i = 1; i <= 6; i++) {
                document.getElementById(`win${i}`).value = winData[i];
            }
            document.getElementById('bonus').value = winData[7];
        } else {
            winningDisplay.innerHTML = `ğŸ“Œ ${targetRound}íšŒ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.`;
            for (let i = 1; i <= 6; i++) {
                document.getElementById(`win${i}`).value = '';
            }
            document.getElementById('bonus').value = '';
        }
        
        // ê²°ê³¼ì°½ ì´ˆê¸°í™”
        document.getElementById('aiMatch').innerHTML = '-';
        document.getElementById('aiMatchedList').innerHTML = '';
        document.getElementById('aiBonus').innerHTML = '';
        document.getElementById('savedMatch').innerHTML = '';

        // íŒì—… ì—´ê¸°
        document.getElementById('reviewPopup').style.display = 'flex';
    }

    function closeReviewPopup() {
        document.getElementById('reviewPopup').style.display = 'none';
    }

    function compareNumbers() {
        // ë‹¹ì²¨ë²ˆí˜¸ ì½ê¸°
        const winning = [];
        for(let i=1; i<=6; i++) {
            const val = parseInt(document.getElementById(`win${i}`).value);
            if(isNaN(val) || val < 1 || val > 45) {
                alert(`${i}ë²ˆì§¸ ë²ˆí˜¸ë¥¼ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥í•˜ì„¸ìš” (1-45)`);
                return;
            }
            winning.push(val);
        }
        const bonus = parseInt(document.getElementById('bonus').value);
        if(isNaN(bonus) || bonus < 1 || bonus > 45) {
            alert('ë³´ë„ˆìŠ¤ ë²ˆí˜¸ë¥¼ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥í•˜ì„¸ìš” (1-45)');
            return;
        }

        const winSet = new Set(winning);
        const allWinningSet = new Set([...winning, bonus]);

        // AI ì¶”ì²œ ìˆ˜ì™€ ë¹„êµ
        const aiMatch = basket.filter(n => winSet.has(n));
        const aiBonusMatch = basket.includes(bonus) ? 1 : 0;
        
        document.getElementById('aiMatch').innerHTML = 
            `AI ì¶”ì²œ ${basket.length}ìˆ˜ ì¤‘ ${aiMatch.length}ê°œ ì¼ì¹˜`;
        document.getElementById('aiMatchedList').innerHTML = 
            aiMatch.length ? `âœ… ì¼ì¹˜ ë²ˆí˜¸: ${aiMatch.join(', ')}` : 'ì¼ì¹˜ ì—†ìŒ';
        document.getElementById('aiBonus').innerHTML = 
            aiBonusMatch ? `âœ¨ ë³´ë„ˆìŠ¤ ë²ˆí˜¸ ${bonus} í¬í•¨ë¨` : '';

        // ë³´ê´€í•¨ ì¡°í•© ë¹„êµ
        const savedMatchDiv = document.getElementById('savedMatch');
        if(savedNumbers.length === 0) {
            savedMatchDiv.innerHTML = 'ì €ì¥ëœ ì¡°í•©ì´ ì—†ìŠµë‹ˆë‹¤.';
            return;
        }

        let matchHtml = '';
        savedNumbers.forEach((key, idx) => {
            const nums = key.split(',').map(Number);
            const matchCount = nums.filter(n => winSet.has(n)).length;
            const hasBonus = nums.includes(bonus);
            let rankInfo = '';
            if (matchCount === 6) rankInfo = 'ğŸ¥‡ 1ë“±';
            else if (matchCount === 5 && hasBonus) rankInfo = 'ğŸ¥ˆ 2ë“±';
            else if (matchCount === 5) rankInfo = 'ğŸ¥‰ 3ë“±';
            else if (matchCount === 4) rankInfo = '4ë“±';
            else if (matchCount === 3) rankInfo = '5ë“±';
            
            if(matchCount > 0 || hasBonus) {
                matchHtml += `<div class="combo-item">`;
                matchHtml += `<span>ì¡°í•© ${idx+1}: ${nums.join(',')}</span>`;
                matchHtml += `<span style="color:${matchCount >= 3 ? '#00ff00' : '#ffd700'}"> ${matchCount}ê°œ ${rankInfo}</span>`;
                if(hasBonus) matchHtml += `<span style="color:#00ccff"> +ë³´ë„ˆìŠ¤</span>`;
                matchHtml += `</div>`;
            }
        });
        
        if(matchHtml === '') {
            savedMatchDiv.innerHTML = 'ì¼ì¹˜í•˜ëŠ” ì¡°í•©ì´ ì—†ìŠµë‹ˆë‹¤.';
        } else {
            savedMatchDiv.innerHTML = matchHtml;
        }

        // AI ì •ë³´ ì˜ì—­ ì—…ë°ì´íŠ¸ (ì¼ì¹˜í•˜ëŠ” ë²ˆí˜¸ í•˜ì´ë¼ì´íŠ¸)
        const reviewAIInfo = document.getElementById('reviewAIInfo');
        if (reviewAIInfo) {
            const survivorsHtml = survivors.map(n => winSet.has(n) ? `<span class="matched">${n}</span>` : n).join(', ');
            const basketHtml = basket.map(n => winSet.has(n) ? `<span class="matched">${n}</span>` : n).join(', ');
            const middleHtml = middle.map(n => winSet.has(n) ? `<span class="matched">${n}</span>` : n).join(', ') || 'ì—†ìŒ';
            const outHtml = compressedOut4.map(n => winSet.has(n) ? `<span class="matched">${n}</span>` : n).join(', ') || 'ì—†ìŒ';
            const replacedInHtml = replacedIn.map(n => winSet.has(n) ? `<span class="matched">${n}</span>` : n).join(', ') || 'ì—†ìŒ';
            const replacedOutHtml = replacedOut.map(n => winSet.has(n) ? `<span class="matched">${n}</span>` : n).join(', ') || 'ì—†ìŒ';

            reviewAIInfo.innerHTML = `
                <div><span class="highlight-blue">ìƒì¡´ì ${survivors.length}ìˆ˜:</span> ${survivorsHtml}</div>
                <div><span class="highlight-gold">AI ì¶”ì²œ ${basket.length}ìˆ˜:</span> ${basketHtml}</div>
                <div><span class="highlight-blue">ğŸ”» 14ìˆ˜ì—ì„œ ë¹ ì§„ ${compressedOut4.length}ê°œ (êµì²´ í›„ ë‚¨ì€):</span> ${outHtml}</div>
                <div><span style="color:#ff6666;">â–¶ êµì²´ëœ ë²ˆí˜¸: ${replacedInHtml}</span></div>
                <div><span style="color:#66aaff;">â—€ êµì²´ë‹¹í•œ ë²ˆí˜¸: ${replacedOutHtml}</span></div>
                <div><span style="color:#aaa;">ğŸ“¦ B bag: ${middleHtml}</span></div>
            `;
        }
    }

    // ===== ì¡°í•© ìƒì„¸ íŒì—… =====
    function openComboDetail(combo) {
        document.getElementById('comboDetailTitle').innerText = `ì¡°í•© ${combo.comboNumber} ìƒì„¸`;
        let html = '<div style="display:flex; gap:5px; justify-content:center; margin-bottom:10px;">';
        html += combo.numbers.map(n => `<span class="num-box" style="width:32px; height:32px;">${n}</span>`).join('');
        html += '</div><div style="font-size:12px;">';
        
        // ê° ë²ˆí˜¸ì˜ ê°€ì¤‘ì¹˜ í‘œì‹œ
        html += '<div style="margin-top:8px;">ğŸ“Š ë²ˆí˜¸ë³„ ê°€ì¤‘ì¹˜</div>';
        combo.numbers.forEach(n => {
            const score = weightedScore[n] || 0;
            html += `<div style="display:flex; justify-content:space-between; padding:2px; border-bottom:1px solid #333;">
                <span>${n}ë²ˆ</span><span style="color:${score > 1 ? '#00ff00' : '#ffd700'}">${score.toFixed(2)}</span>
            </div>`;
        });
        
        html += '</div>';
        document.getElementById('comboDetailContent').innerHTML = html;
        document.getElementById('comboDetailPopup').style.display = 'flex';
    }

    function closeComboDetailPopup() {
        document.getElementById('comboDetailPopup').style.display = 'none';
    }

    // ===== ì´ˆê¸°í™” =====
    function initialize() {
        initUser();
        analyze();
        document.getElementById('compressRange').value = currentCompress;
        document.getElementById('compressValue').innerText = currentCompress;
        document.getElementById('intervalWeeks').value = intervalWeeks;
        document.getElementById('refCount').value = referenceCount;
        document.getElementById('baseRoundInput').value = currentBaseRound;
        
        // í˜ì´ì§€ ì´íƒˆ ì‹œ ê²Œì„ ì •ë¦¬
        window.addEventListener('beforeunload', () => {
            if(touchInterval) clearInterval(touchInterval);
        });
    }

    // ì‹¤í–‰
    initialize();
</script>
</body>
</html>
