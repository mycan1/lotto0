<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ì‹ ì˜ ì† - ì›ë³¸ í†µê³„ ë³µì› ì—”ì§„</title>
    <style>
        body { background-color: #0c0c0c; color: #f2c94c; font-family: 'Malgun Gothic', sans-serif; text-align: center; padding: 20px; margin: 0; }
        h1 { color: #f2c94c; font-size: 2.5rem; margin-top: 30px; margin-bottom: 25px; font-weight: bold; letter-spacing: -1px; cursor: pointer; }
        .target-box { color: #FFF; font-size: 1.2rem; margin-bottom: 20px; background: #1a1a1a; padding: 12px 20px; border-radius: 10px; display: inline-block; border: 2px solid #f2c94c; font-weight: bold; }
        .status-badge { display: block; margin: 10px auto; font-size: 0.9rem; color: #ff4d4d; font-weight: bold; }
        .btn-container { display: flex; flex-wrap: wrap; justify-content: center; gap: 8px; max-width: 400px; margin: 0 auto 15px auto; }
        button { border: none; border-radius: 8px; cursor: pointer; font-size: 17px; font-weight: bold; transition: 0.2s; position: relative; display: flex; align-items: center; justify-content: center; }
        .btn-main { width: 100%; height: 60px; background-color: #d4a017; color: black; margin-bottom: 5px; }
        .btn-sub { width: 48.5%; height: 55px; background-color: #262626; color: white; border: 1px solid #333; }
        #console-container { width: 100%; max-width: 400px; margin: 15px auto; background-color: #1a1a1a; border-radius: 12px; border: 2px solid #333; overflow: hidden; }
        #console { width: 100%; height: 350px; padding: 15px; text-align: left; overflow-y: auto; color: #f2c94c; box-sizing: border-box; font-size: 15px; line-height: 1.6; white-space: pre-wrap; font-family: monospace; }
        .timer-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: none; align-items: center; justify-content: center; border-radius: 8px; color: #ff4d4d; }
        #storage-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 1000; overflow-y: auto; padding: 20px 0; }
        .modal-content { background: #1a1a1a; width: 90%; max-width: 380px; margin: 0 auto; padding: 20px; border: 2px solid #f2c94c; border-radius: 15px; }
        .close-btn { background: #ff4d4d; color: white; width: 100%; height: 50px; border-radius: 8px; margin-top: 20px; font-size: 18px; border: none; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>
    <h1 onclick="location.reload()">ì‹ ì˜ ì†</h1>
    <div class="target-box" id="display-target">ğŸ¯ ë°ì´í„° ì—°ê²° ëŒ€ê¸° ì¤‘...</div>
    <div id="system-status" class="status-badge"></div>

    <div class="btn-container">
        <button class="btn-main" id="btn10" onclick="processOriginal()">ì‚¬ìš©ì ì›ë³¸ ë¡œì§ 10ì¡°í•© ìƒì„±<div id="timer10" class="timer-overlay"></div></button>
        <button class="btn-sub" onclick="showStorage()">ë§ˆí‚¹ ë³´ê´€í•¨</button>
        <button class="btn-sub" onclick="clearAll()">ì „ì²´ ì‚­ì œ</button>
    </div>

    <div id="console-container"><div id="console">â–¶ ì‹œìŠ¤í…œ ì¤€ë¹„ ì¤‘...</div></div>

    <div id="storage-modal"><div class="modal-content"><div id="list-history"></div><button class="close-btn" onclick="closeModal()">ì°½ ë‹«ê¸°</button></div></div>

    <script>
        const MY_DATA_FILE = 'lotto.txt';
        let rawData = []; // ì „ì²´ ë°ì´í„° (íšŒì°¨ í¬í•¨)
        let isAttackMode = false;
        let elitePool = [];
        let missingPool = [];
        let lastWeekNums = [];
        let storageData = JSON.parse(localStorage.getItem('kingStorageFinal')) || [];

        // [ì›ë³¸ ë¡œì§] AC ê³„ì‚°
        function getAC(arr) {
            let d = new Set();
            for (let i = 0; i < 6; i++) {
                for (let j = i + 1; j < 6; j++) d.add(Math.abs(arr[i] - arr[j]));
            }
            return d.size - 5;
        }

        // [ì›ë³¸ ë¡œì§] ì—°ë²ˆ ì²´í¬ (3ì—°ë²ˆ ì°¨ë‹¨)
        function isSequentialOk(nums, allowDoublePair = false) {
            let consecutivePairs = 0;
            for (let i = 0; i < nums.length - 1; i++) {
                if (nums[i] + 1 === nums[i + 1]) {
                    if (i < nums.length - 2 && nums[i + 1] + 1 === nums[i + 2]) return false; // 3ì—°ë²ˆ ê¸ˆì§€
                    consecutivePairs++;
                    i++;
                }
            }
            return consecutivePairs <= (allowDoublePair ? 2 : 1);
        }

        async function loadAndAnalyze() {
            const consoleBox = document.getElementById('console');
            const targetBox = document.getElementById('display-target');
            const statusBox = document.getElementById('system-status');
            try {
                const response = await fetch(MY_DATA_FILE + '?v=' + Math.random());
                const text = await response.text();
                const lines = text.trim().split('\n').filter(l => l.length > 0);
                
                let maxRound = 0;
                rawData = lines.map(line => {
                    const row = line.split(',').map(Number);
                    if (row[0] > maxRound) maxRound = row[0];
                    return row;
                });

                // 1. ê³µê²© íƒ€ì´ë° ë¶„ì„ (ìµœê·¼ 5íšŒì°¨ ì¤‘ ì—°ë²ˆ ë°œìƒ ë¹ˆë„ ì²´í¬)
                let clusterScore = 0;
                const recent5 = rawData.slice(0, 5);
                recent5.forEach(row => {
                    const nums = row.slice(1, 7).sort((a,b)=>a-b);
                    if (nums.some((n, i) => n + 1 === nums[i+1])) clusterScore++;
                });
                isAttackMode = clusterScore >= 3;

                // 2. ë²ˆí˜¸ í’€ ìƒì„± (ìµœê·¼ 30íšŒ ê¸°ì¤€)
                const recent30 = rawData.slice(0, 30);
                let counts = {};
                recent30.forEach(row => {
                    row.slice(1, 7).forEach(n => counts[n] = (counts[n] || 0) + 1);
                });
                
                lastWeekNums = rawData[0].slice(1, 7);
                elitePool = Object.keys(counts).filter(n => counts[n] >= 2 && counts[n] <= 4).map(Number);
                missingPool = Array.from({length: 45}, (_, i) => i + 1).filter(n => !counts[n]);
                
                targetBox.innerHTML = `ğŸ¯ ì œ ${maxRound + 1}íšŒì°¨ ë¶„ì„ ì—”ì§„`;
                statusBox.innerHTML = isAttackMode ? "âš ï¸ í˜„ì¬ ì‹œìŠ¤í…œ ìƒíƒœ: [ê³µê²©ëª¨ë“œ - ì§‘ì¤‘íƒ€ê²©]" : "âœ… í˜„ì¬ ì‹œìŠ¤í…œ ìƒíƒœ: [ì•ˆì •ëª¨ë“œ - ê· í˜•ë¶„ì„]";
                consoleBox.innerHTML = `âœ… ë°ì´í„° ì—°ë™ ì„±ê³µ (${maxRound}íšŒ ê¸°ë°˜)\nâ–¶ ì›ë³¸ í†µê³„ í•„í„° ë° ë‚šì•„ì±„ê¸° ë¡œì§ ë³µì› ì™„ë£Œ.`;
            } catch (err) {
                consoleBox.innerHTML = "âŒ lotto.txt íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
            }
        }

        function processOriginal() {
            if (rawData.length === 0) return;
            const box = document.getElementById('console');
            box.innerHTML = `â–¶ [ì›ë³¸ ë¡œì§ 10ì¡°í•© ìƒì„± ì‹œì‘]\n`;
            let results = [];
            let timeStr = new Date().getHours() + ":" + (new Date().getMinutes()<10?'0':'') + new Date().getMinutes();

            // 1~7ë²ˆ ì¡°í•©: ì›ë³¸ í†µê³„ (í•© 100-170, AC 5-8, í™€ì§ 2:4~4:2)
            while (results.length < 7) {
                let candidate = Array.from({length: 45}, (_, i) => i + 1).sort(() => Math.random() - 0.5).slice(0, 6).sort((a,b)=>a-b);
                let sum = candidate.reduce((a, b) => a + b, 0);
                let ac = getAC(candidate);
                let oddCount = candidate.filter(n => n % 2 !== 0).length;

                if (sum >= 100 && sum <= 170 && ac >= 5 && ac <= 8 && [2,3,4].includes(oddCount) && isSequentialOk(candidate, false)) {
                    results.push({tag: "ì›ë³¸í†µê³„", num: candidate});
                }
            }

            // 8~10ë²ˆ ì¡°í•©: ì§‘ì¤‘ íƒ€ê²© (ë¯¸ì¶œìˆ˜ ê²°í•© ë° ê³µê²©ëª¨ë“œ ì‹œ ìŒì—°ë²ˆ í—ˆìš©)
            for (let i = 1; i <= 3; i++) {
                let mPick = missingPool.sort(() => Math.random() - 0.5).slice(0, i);
                let pool = [...new Set([...elitePool, ...lastWeekNums])];
                let safety = 0;
                while (safety < 1000) {
                    safety++;
                    let base = pool.sort(() => Math.random() - 0.5).slice(0, 6 - mPick.length);
                    let candidate = [...new Set([...base, ...mPick])].sort((a,b)=>a-b);
                    if (candidate.length === 6 && candidate.reduce((a,b)=>a+b,0) >= 100 && isSequentialOk(candidate, isAttackMode && i < 3)) {
                        results.push({tag: `ì§‘ì¤‘íƒ€ê²©_${i}`, num: candidate});
                        break;
                    }
                }
            }

            // ê²°ê³¼ ì¶œë ¥ ë° ì €ì¥
            results.forEach((item, idx) => {
                let s = item.num.map(n => n < 10 ? "0" + n : n).join("  ");
                let mark = !isSequentialOk(item.num, false) ? " (ìŒ)" : "";
                box.innerHTML += `(${idx + 1}) [${item.tag}] ${s}${mark}\n`;
                storageData.push({time: timeStr, info: `[${item.tag}] ${s}${mark}`});
            });
            
            localStorage.setItem('kingStorageFinal', JSON.stringify(storageData));
            startTimer('10');
        }

        // --- ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤ ---
        function showStorage() {
            const listDiv = document.getElementById('list-history');
            listDiv.innerHTML = '<div style="color:#f2c94c; font-weight:bold; padding:10px;">ğŸ“œ ìµœê·¼ ìƒì„± ê¸°ë¡</div>';
            storageData.slice(-20).reverse().forEach(item => {
                listDiv.innerHTML += `<div style="color:#FFF; padding:8px; border-bottom:1px solid #333; font-size:13px; text-align:left;">[${item.time}] ${item.info}</div>`;
            });
            document.getElementById('storage-modal').style.display = 'block';
        }
        function closeModal() { document.getElementById('storage-modal').style.display = 'none'; }
        function clearAll() { if(confirm("ê¸°ë¡ì„ ì‚­ì œí• ê¹Œìš”?")) { localStorage.removeItem('kingStorageFinal'); location.reload(); } }
        function startTimer(m) {
            let b = document.getElementById('btn'+m), o = document.getElementById('timer'+m);
            b.disabled = true; o.style.display = 'flex';
            let e = new Date().getTime() + 60000;
            let t = setInterval(() => {
                let r = e - new Date().getTime();
                if(r <= 0) { clearInterval(t); b.disabled = false; o.style.display = 'none'; }
                else { o.innerText = Math.ceil(r/1000) + "ì´ˆ"; }
            }, 100);
        }

        loadAndAnalyze();
    </script>
</body>
</html>
