<script>
    // [ë³´ì•ˆì½”ë“œ ì ìš© ë°ì´í„°ë±…í¬]
    const FULL_DATA = [[1211,23,26,27,35,38,40,10],[1210,1,7,9,17,27,38,31],[1209,2,17,20,35,37,39,24],[1208,6,27,30,36,38,42,25],[1207,10,22,24,27,38,45,11],[1206,1,3,17,26,27,42,23],[1205,1,4,16,23,31,41,2],[1204,8,16,28,30,31,44,27],[1203,3,6,18,29,35,39,24],[1202,5,12,21,33,37,40,7],[1201,7,9,24,27,35,36,37],[1200,1,2,4,16,20,32,45],[1199,16,24,25,30,31,32,7],[1198,26,30,33,38,39,41,21],[1197,1,5,7,26,28,43,30],[1196,8,12,15,29,40,45,14],[1195,3,15,27,33,34,36,37],[1194,3,13,15,24,33,37,2],[1193,6,9,16,19,24,28,17],[1192,10,16,23,36,39,40,11],[1191,1,4,11,12,20,41,2],[1190,7,9,19,23,26,45,33],[1189,9,19,29,35,37,38,31],[1188,3,4,12,19,22,27,9],[1187,5,13,26,29,37,40,42],[1186,2,8,13,16,23,28,35],[1185,6,17,22,28,29,32,38],[1184,14,16,23,25,31,37,42],[1183,4,15,17,23,27,36,31],[1182,1,13,21,25,28,31,22],[1181,8,10,14,20,33,41,28],[1180,6,12,18,37,40,41,3],[1179,3,16,18,24,40,44,21],[1178,5,6,11,27,43,44,17],[1177,3,7,15,16,19,43,21],[1176,7,9,11,21,30,35,29],[1175,3,4,6,8,32,42,31],[1174,8,11,14,17,36,39,22],[1173,1,5,18,20,30,35,3],[1172,7,9,24,40,42,44,45],[1171,3,6,7,11,12,17,19],[1170,3,13,28,34,38,42,25],[1169,5,12,24,26,39,42,20],[1168,9,21,24,30,33,37,29],[1167,8,23,31,35,39,40,24],[1166,14,23,25,27,29,42,16],[1165,6,7,27,29,38,45,17],[1164,17,18,23,25,38,39,22],[1163,2,13,15,16,33,43,4],[1162,20,21,22,25,28,29,6],[1161,2,12,20,24,34,42,37],[1160,7,13,18,36,39,45,19],[1159,3,9,27,28,38,39,7],[1158,21,25,27,32,37,38,20],[1157,5,7,12,20,25,26,28],[1156,30,31,34,39,41,45,7],[1155,10,16,19,27,37,38,13],[1154,4,8,22,26,32,38,27],[1153,1,9,10,13,35,44,5],[1152,30,31,32,35,36,37,5],[1151,2,3,9,15,27,29,8],[1150,8,9,18,35,39,45,25],[1149,8,15,19,21,32,36,38],[1148,3,6,13,15,16,22,32],[1147,7,11,24,26,27,37,32],[1146,6,11,17,19,40,43,28],[1145,2,11,31,33,37,44,32],[1144,3,4,12,15,26,34,6],[1143,10,16,17,27,28,36,6],[1142,2,8,28,30,37,41,22],[1141,7,11,12,21,26,35,20],[1140,7,10,22,29,31,38,15],[1139,5,12,15,30,37,40,18],[1138,14,16,19,20,29,34,35],[1137,4,9,12,15,33,45,26],[1136,21,33,35,38,42,44,1],[1135,1,6,13,19,21,33,4],[1134,3,7,9,13,19,24,23],[1133,13,14,20,28,29,34,23],[1132,6,7,19,28,34,41,5],[1131,1,2,6,14,27,38,33],[1130,15,19,21,25,27,28,40],[1129,5,10,11,17,28,34,22],[1128,1,5,8,16,28,33,45],[1127,10,15,24,30,31,37,32],[1126,4,5,9,11,37,40,7],[1125,6,14,25,33,40,44,30],[1124,3,8,17,30,33,34,28],[1123,13,19,21,24,34,35,26],[1122,3,6,21,30,34,35,22],[1121,6,24,31,32,38,44,8],[1120,2,19,26,31,38,41,34],[1119,1,9,12,13,20,45,3],[1118,11,13,14,15,16,45,3],[1117,3,4,9,30,33,36,7],[1116,15,16,17,25,30,31,32],[1115,7,12,23,32,34,36,8],[1114,10,16,19,32,33,38,3],[1113,11,13,20,21,32,44,8],[1112,16,20,26,36,42,44,24]];

    let basket = [], zeroFreqNums = [], machineFixed = [];
    let dynamicAvgSum = 145;

    // ===== ìˆ˜ì •ëœ ë¶€ë¶„ =====
    // ì €ì¥ëœ ë²ˆí˜¸ ë¶ˆëŸ¬ì˜¤ê¸° (localStorage + URL í•´ì‹œ ëª¨ë‘ ì²´í¬)
    let savedNumbers = [];
    
    function loadSavedNumbers() {
        // 1. localStorageì—ì„œ ë¶ˆëŸ¬ì˜¤ê¸°
        const localData = localStorage.getItem('lottoSaveV24');
        if (localData) {
            savedNumbers = JSON.parse(localData);
        } else {
            savedNumbers = [];
        }
        
        // 2. URL í•´ì‹œ(#)ì—ì„œ ë¶ˆëŸ¬ì˜¤ê¸° (ì˜êµ¬ì €ì¥ìš©)
        const hash = window.location.hash.substring(1);
        if (hash) {
            try {
                const urlNumbers = hash.split(',').map(Number);
                // URLì— ì €ì¥ëœ ë²ˆí˜¸ê°€ ìˆê³ , localStorageì— ì—†ìœ¼ë©´ ì¶”ê°€
                if (urlNumbers.length === 6 && !savedNumbers.includes(urlNumbers.join(','))) {
                    savedNumbers.push(urlNumbers.join(','));
                    localStorage.setItem('lottoSaveV24', JSON.stringify(savedNumbers));
                }
            } catch(e) {}
        }
    }
    
    // ì €ì¥ í•¨ìˆ˜ (localStorage + URL ì—…ë°ì´íŠ¸)
    function saveToBox(s) {
        if(!savedNumbers.includes(s)) {
            savedNumbers.push(s);
            localStorage.setItem('lottoSaveV24', JSON.stringify(savedNumbers));
            
            // URL í•´ì‹œ ì—…ë°ì´íŠ¸ (ì˜êµ¬ì €ì¥)
            window.location.hash = s;
            
            alert("ë³´ê´€í•¨ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤ (ì˜êµ¬ì €ì¥ë¨)");
        } else {
            alert("ì´ë¯¸ ì €ì¥ëœ ë²ˆí˜¸ì…ë‹ˆë‹¤");
        }
    }
    
    // ê°œë³„ ì‚­ì œ í•¨ìˆ˜
    function deleteSingleItem(index) {
        if(confirm("ì´ ì¡°í•©ì„ ì‚­ì œí• ê¹Œìš”?")) {
            savedNumbers.splice(index, 1);
            localStorage.setItem('lottoSaveV24', JSON.stringify(savedNumbers));
            renderStorage(); // ë³´ê´€í•¨ ê°±ì‹ 
            
            // ë§ˆì§€ë§‰ í•­ëª© ì‚­ì œì‹œ URL í•´ì‹œ ì œê±°
            if (savedNumbers.length === 0) {
                window.location.hash = '';
            }
        }
    }
    
    // ì €ì¥ëœ ë²ˆí˜¸ ë¶ˆëŸ¬ì˜¤ê¸° (í´ë¦­í•˜ë©´ ë²ˆí˜¸íŒì— í‘œì‹œ)
    function loadFromStorage(nums) {
        const numArr = nums.split(',').map(Number);
        
        // ë©”ì¸ í™”ë©´ì— í‘œì‹œ (ê°„ë‹¨íˆ ì•Œë¦¼)
        alert(`ì„ íƒëœ ë²ˆí˜¸: ${numArr.join(', ')}\nì´ ë²ˆí˜¸ë¡œ ë¶„ì„ì„ ì›í•˜ì‹œë©´ ìƒˆë¡œê³ ì¹¨ í›„ ì‚¬ìš©í•˜ì„¸ìš”`);
        
        // URL í•´ì‹œ ì—…ë°ì´íŠ¸ (ì˜êµ¬ì €ì¥)
        window.location.hash = nums;
        closePopup();
    }
    
    // ë³´ê´€í•¨ ë Œë”ë§ (ê°œë³„ ì‚­ì œ + ë¶ˆëŸ¬ì˜¤ê¸° ë²„íŠ¼ ì¶”ê°€)
    function renderStorage() {
        const st = document.getElementById('storage');
        if(savedNumbers.length === 0) { 
            st.innerHTML = "<div style='text-align:center; padding:20px; opacity:0.5;'>ì €ì¥ëœ ì¡°í•©ì´ ì—†ìŠµë‹ˆë‹¤.</div>"; 
            return; 
        }
        
        st.innerHTML = savedNumbers.map((n, index) => {
            const numbers = n.split(',');
            return `
                <div class="row-line" style="margin-bottom:10px; position:relative;">
                    <div class="num-container" style="cursor:pointer;" onclick="loadFromStorage('${n}')">
                        ${numbers.map(v=>`<span class="num-box normal" style="background:#333; font-size:12px;">${v}</span>`).join('')}
                    </div>
                    <div style="display:flex; gap:5px;">
                        <button onclick="event.stopPropagation(); loadFromStorage('${n}')" 
                                style="background:#00ccff; color:white; border:none; border-radius:5px; padding:5px 8px; font-size:11px; cursor:pointer;">ë¶ˆëŸ¬ì˜¤ê¸°</button>
                        <button onclick="event.stopPropagation(); deleteSingleItem(${index})" 
                                style="background:#ff4444; color:white; border:none; border-radius:5px; padding:5px 8px; font-size:11px; cursor:pointer;">ì‚­ì œ</button>
                    </div>
                </div>
            `;
        }).join('');
    }
    // ===== ìˆ˜ì • ë =====

    function analyze() {
        let freq = {};
        for(let i=1; i<=45; i++) freq[i] = 0;
        
        // â˜… 1. ë¯¸ì¶œìˆ˜ ë¶„ì„ ê¸°ì¤€: ìµœê·¼ 25íšŒ (ë³´ë„ˆìŠ¤ í¬í•¨)
        const zeroRange = 25;
        const data25 = FULL_DATA.slice(0, zeroRange);
        let freq25 = {};
        for(let i=1; i<=45; i++) freq25[i] = 0;
        data25.forEach(row => { for(let j=1; j<=7; j++) { if(row[j]) freq25[row[j]]++; } });
        zeroFreqNums = Object.keys(freq25).filter(n => freq25[n] === 0).map(Number).sort((a,b)=>a-b);

        // â˜… 2. ë¹ˆë„ ë¶„ì„ ê¸°ì¤€: ìµœê·¼ 30íšŒ (ê°€ì¤‘ì¹˜ ê³„ì‚°ìš©)
        const targetRange = 30;
        const data30 = FULL_DATA.slice(0, targetRange);
        data30.forEach(row => { for(let j=1; j<=7; j++) { if(row[j]) freq[row[j]]++; } });

        let sortedByFreq = Object.keys(freq).map(Number).sort((a,b) => freq[b] - freq[a]);
        let top22Freq = sortedByFreq.slice(0, 22);

        let pScores = {};
        for(let i=1; i<=45; i++) pScores[i] = (freq[i] || 0) * 2;
        
        let nextSums = [];
        for(let i=1; i < targetRange; i++) {
            let currentNums = FULL_DATA[i].slice(1, 7);
            let hasTop22 = currentNums.some(n => top22Freq.includes(n));
            if(hasTop22 && i+1 < FULL_DATA.length) {
                FULL_DATA[i+1].slice(1, 7).forEach(n => pScores[n] += 5);
                let sum = FULL_DATA[i+1].slice(1, 7).reduce((a,b)=>a+b, 0);
                nextSums.push(sum);
            }
        }

        if (nextSums.length > 0) dynamicAvgSum = Math.round(nextSums.reduce((a,b)=>a+b, 0) / nextSums.length);

        let scored = Object.keys(pScores).map(Number).sort((a,b) => pScores[b] - pScores[a]);
        basket = scored.slice(0, 16); // 16ìˆ˜ë¡œ ì†Œí­ í™•ì¥
        machineFixed = [scored[0], scored[1], scored[2]];

        document.getElementById('status').innerHTML = `
            <div><span class="highlight-gold">â˜… SHIN-UI-SON v24.1 ì—”ì§„ ê°€ë™</span></div>
            <div><span class="highlight-red">ğŸ¯ ë¯¸ì¶œìˆ˜(ìµœê·¼ 25íšŒ ê¸°ì¤€):</span> ${zeroFreqNums.length > 0 ? zeroFreqNums.join(', ') : 'ì—†ìŒ'}</div>
            <div>ì••ì¶• í›„ë³´ 16ìˆ˜: ${basket.sort((a,b)=>a-b).join(', ')}</div>
            <div><span class="highlight-blue">ğŸ“Š ë‹¤ìŒ íšŒì°¨ ê¸°ëŒ€ í•©ê³„:</span> ${dynamicAvgSum}</div>
            <div><span class="highlight-blue">âš–ï¸ í•„í„°ë§ ë²”ìœ„:</span> ${dynamicAvgSum-28} ~ ${dynamicAvgSum+28}</div>
            <div style="margin-top:5px; color:#fff; font-size:10px;">â€» 9,10ë²ˆ ì¡°í•©ì— 25íšŒ ë¯¸ì¶œìˆ˜ ê°•ì œ í¬í•¨ ë¡œì§ ì ìš©ë¨</div>
        `;
    }

    function process(limit) {
        analyze();
        const box = document.getElementById('console');
        box.innerHTML = "";
        let count = 0, used = new Set(), safety = 0;
        let minSum = dynamicAvgSum - 28;
        let maxSum = dynamicAvgSum + 28;

        while(count < limit && safety < 10000) {
            safety++;
            let res = new Set();
            let currentIdx = count + 1;

            // 9, 10ë²ˆ ì¡°í•© ë¯¸ì¶œìˆ˜ ê°•ì œ í¬í•¨
            if (limit === 10 && (currentIdx === 9 || currentIdx === 10) && zeroFreqNums.length > 0) {
                let zeroNum = zeroFreqNums[Math.floor(Math.random() * zeroFreqNums.length)];
                res.add(zeroNum);
            } else if (Math.random() > 0.8 && zeroFreqNums.length > 0) {
                // ì¼ë°˜ ì¡°í•©ì—ì„œë„ 20% í™•ë¥ ë¡œ ë¯¸ì¶œìˆ˜ í¬í•¨
                res.add(zeroFreqNums[Math.floor(Math.random() * zeroFreqNums.length)]);
            }

            // ê³ ì •ìˆ˜ ì „ëµ (5ì¡°í•©ì¼ ë•Œ ê°•í™”)
            if(limit === 5) res.add(machineFixed[Math.floor(Math.random()*3)]);

            // í›„ë³´ìˆ˜(basket)ì—ì„œ ì±„ìš°ê¸°
            let shuffleBasket = [...basket].sort(() => Math.random() - 0.5);
            for(let n of shuffleBasket) { if(res.size < 6) res.add(n); }

            // ì™„ì „ ëœë¤ ë³´ì • (ë‹¤ì–‘ì„± í™•ë³´)
            while(res.size < 6) res.add(Math.floor(Math.random()*45)+1);

            let finalArr = Array.from(res).sort((a,b)=>a-b);
            let sum = finalArr.reduce((a,b)=>a+b, 0);
            let key = finalArr.join(',');

            if(!used.has(key) && sum >= minSum && sum <= maxSum) {
                used.add(key);
                count++;
                let specialMark = (limit === 10 && (count === 9 || count === 10)) ? 'ğŸ”¥ 25íšŒ ë¯¸ì¶œìˆ˜' : '';
                renderRow(finalArr, box, key, specialMark);
            }
        }
    }

    function renderRow(arr, target, key, specialMark = '') {
        const html = arr.map(n => {
            let cls = machineFixed.includes(n) ? "fixed" : (zeroFreqNums.includes(n) ? "zero" : "normal");
            return `<span class="num-box ${cls}">${n}</span>`;
        }).join('');
        let specialHtml = specialMark ? `<span class="badge">${specialMark}</span>` : '';
        target.innerHTML += `<div class="row-line"><div class="num-container">${html}</div><div style="display: flex; align-items: center;">${specialHtml}<div class="save-btn" onclick="saveToBox('${key}')">ì €ì¥</div></div></div>`;
    }

    // íŒì—… ì—´ê¸°
    function openPopup() {
        document.getElementById('popup').style.display = 'flex';
        renderStorage();
    }

    // íŒì—… ë‹«ê¸°
    function closePopup() {
        document.getElementById('popup').style.display = 'none';
    }

    // ì´ˆê¸°í™” í•¨ìˆ˜ ìˆ˜ì •
    function clearStorage() {
        if(confirm("ë³´ê´€í•¨ì„ ì´ˆê¸°í™”í• ê¹Œìš”?")) {
            savedNumbers = [];
            localStorage.removeItem('lottoSaveV24');
            window.location.hash = ''; // URL í•´ì‹œë„ ì œê±°
            renderStorage();
        }
    }
    
    // í˜ì´ì§€ ë¡œë“œì‹œ ì‹¤í–‰
    window.onload = function() {
        loadSavedNumbers(); // ì €ì¥ëœ ë²ˆí˜¸ ë¨¼ì € ë¶ˆëŸ¬ì˜¤ê¸°
        analyze(); // ë¶„ì„ ì‹¤í–‰
    };
</script>
